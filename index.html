<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- PWA primary tags -->
    <meta name="theme-color" content="#ec4899">
    <meta name="description" content="GK Store - Exclusive Video Marketplace. Buy & book premium video accounts.">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GK Store">
    <meta name="application-name" content="GK Store">
    
    <!-- Web Manifest - linked externally -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS icons - using correct GitHub paths -->
    <link rel="apple-touch-icon" sizes="72x72" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-72-72.png">
    <link rel="apple-touch-icon" sizes="96x96" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-96-96.png">
    <link rel="apple-touch-icon" sizes="144x144" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-144-144.png">
    <link rel="apple-touch-icon" sizes="192x192" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-192-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-512-512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="72x72" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-72-72.png">
    <link rel="icon" type="image/png" sizes="96x96" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-96-96.png">
    <link rel="icon" type="image/png" sizes="144x144" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-144-144.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-192-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-512-512.png">
    
    <title>GK Store - Video Marketplace</title>
    
    <!-- Supabase & Font Awesome -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === Base & Variables === */
        :root {
            --primary: #ec4899;
            --primary-dark: #db2777;
            --secondary: #8b5cf6;
            --secondary-dark: #7c3aed;
            --accent: #f59e0b;
            --background: #000000;
            --surface: #18181b;
            --surface-light: #27272a;
            --text: #ffffff;
            --text-secondary: #a1a1aa;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #3f3f46;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --gradient-login: linear-gradient(135deg, #ec4899, #8b5cf6, #3b82f6);
            --liked-color: #ef4444;
        }

        [data-theme="light"] {
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-light: #f1f5f9;
            --text: #020617;
            --text-secondary: #475569;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html { 
            font-size: 16px; 
            scroll-behavior: smooth;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes shimmer { 0% { background-position: -200% center; } 100% { background-position: 200% center; } }
        @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-spin { animation: spin 1s linear infinite; }
        .shimmer { background: linear-gradient(90deg, var(--surface-light) 0%, var(--surface) 50%, var(--surface-light) 100%); background-size: 200% auto; animation: shimmer 2s infinite linear; }

        /* Utility */
        .gradient-text { background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .gradient-text-login { background: var(--gradient-login); -webkit-background-clip: text; background-clip: text; color: transparent; background-size: 200% auto; animation: gradientFlow 3s ease infinite; }
        .gradient-bg { background: var(--gradient); }
        .gradient-bg-login { background: var(--gradient-login); background-size: 200% auto; animation: gradientFlow 3s ease infinite; }
        .glass-effect { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .blur-bg { backdrop-filter: blur(20px); background: rgba(0,0,0,0.5); }
        .hidden { display: none !important; }

        /* Layout - TikTok/Reels Style */
        .app-container { height: 100vh; height: 100dvh; overflow: hidden; position: relative; }
        .page { height: 100%; overflow: hidden; position: relative; }
        #home-page { background: #000; }
        .reels-container { height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; scroll-behavior: smooth; position: relative; background: #000; }
        .reel-item { height: 100%; scroll-snap-align: start; scroll-snap-stop: always; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        .reel-video-container { width: 100%; height: 100%; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        .reel-video { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .reel-video.fullscreen-mode { position: fixed !important; top: 0 !important; left: 0 !important; width: 100vw !important; height: 100vh !important; z-index: 9999 !important; object-fit: contain !important; background: #000 !important; }
        @media (orientation: landscape) { .reel-video.auto-rotate { object-fit: cover !important; width: 100vw !important; height: 100vh !important; } }
        .reel-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.5) 100%); pointer-events: none; z-index: 5; }
        .reel-info { position: absolute; bottom: 100px; left: 16px; right: 80px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.5); pointer-events: none; z-index: 10; }
        .reel-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .reel-description { font-size: 0.9rem; color: rgba(255,255,255,0.9); margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .reel-stats { display: flex; gap: 16px; font-size: 0.85rem; color: rgba(255,255,255,0.8); }
        
        /* Reel Actions - Fixed positioning and spacing */
        .reel-actions { 
            position: absolute; 
            right: 12px; 
            bottom: 120px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            z-index: 30; 
            pointer-events: none;
            max-height: calc(100% - 200px);
            overflow-y: visible;
        }
        
        .reel-action-btn { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 4px; 
            color: white; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); 
            pointer-events: auto; 
            cursor: pointer; 
            transition: transform 0.2s;
            position: relative;
            z-index: 35;
        }
        
        .reel-action-btn:hover { transform: scale(1.1); }
        
        .reel-action-btn .icon-circle { 
            width: 48px; 
            height: 48px; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(10px); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.4rem; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        
        .reel-action-btn span { font-size: 0.7rem; font-weight: 600; }
        .reel-action-btn.liked .icon-circle i { color: var(--liked-color) !important; }
        .reel-action-btn.liked .icon-circle { border-color: var(--liked-color) !important; }

        /* Video Info Button - Positioned on the left side to avoid overlap */
        .video-info-btn {
            position: absolute;
            top: 60px;
            left: 16px;
            width: 44px;
            height: 44px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            z-index: 40;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.2s;
        }
        
        .video-info-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        /* Rotate button now positioned on the right side */
        .reel-action-btn.rotate-btn {
            margin-top: 0;
        }

        /* Video Info Drawer - Facebook Style (scrollable full screen) */
        .video-info-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .video-info-drawer {
            background: var(--surface);
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        
        .video-info-drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        
        .video-info-drawer-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .video-info-drawer-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface-light);
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .video-info-drawer-close:hover {
            background: var(--primary);
            color: white;
        }
        
        .video-info-drawer-content {
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            max-height: calc(85vh - 80px);
        }
        
        .video-info-section {
            margin-bottom: 24px;
        }
        
        .video-info-section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .video-info-section-content {
            font-size: 1rem;
            color: var(--text);
            line-height: 1.6;
        }
        
        .video-info-price-tag {
            display: inline-block;
            background: var(--gradient);
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            margin-top: 8px;
        }
        
        .video-info-tier-badge {
            display: inline-block;
            background: var(--surface-light);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .video-info-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        .video-info-action-btn {
            flex: 1;
            padding: 14px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .video-info-action-btn.book {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .video-info-action-btn.book:hover {
            background: var(--primary);
            color: white;
        }
        
        .video-info-action-btn.buy {
            background: var(--gradient);
            color: white;
        }
        
        .video-info-action-btn.buy:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(236,72,153,0.3);
        }

        .rotate-indicator { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); color: white; padding: 8px 16px; border-radius: 30px; font-size: 0.8rem; z-index: 45; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.2); animation: fadeInOut 3s forwards; pointer-events: none; }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translateX(-50%) translateY(-10px); } 10% { opacity: 1; transform: translateX(-50%) translateY(0); } 90% { opacity: 1; transform: translateX(-50%) translateY(0); } 100% { opacity: 0; transform: translateX(-50%) translateY(-10px); } }
        .reel-top-gradient { position: absolute; top: 0; left: 0; right: 0; height: 80px; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); z-index: 15; pointer-events: none; }
        .play-pause-indicator { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.6); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 25; }
        .play-pause-indicator.show { opacity: 1; animation: fadeOut 0.5s forwards; }
        @keyframes fadeOut { 0% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.5); } }

        /* === Draggable progress bar (scrubber) styles === */
        .video-progress-container {
            position: absolute;
            bottom: 70px;
            left: 16px;
            right: 80px;
            height: 5px;
            background: rgba(255,255,255,0.2);
            border-radius: 5px;
            z-index: 50;
            cursor: pointer;
            pointer-events: auto;
            touch-action: none;
        }
        .video-progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 5px;
            width: 0%;
            pointer-events: none;
        }
        .video-progress-handle {
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            left: 0%;
            pointer-events: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.6);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .video-progress-container.dragging .video-progress-handle,
        .video-progress-container:hover .video-progress-handle {
            opacity: 1;
        }

        /* === Navigation & Cards === */
        .top-nav { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 1rem; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); }
        .nav-content { display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-weight: 700; text-decoration: none; color: var(--text); }
        .logo-icon { width: 2rem; height: 2rem; background: var(--gradient); border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: white; }
        .nav-actions { display: flex; align-items: center; gap: 0.5rem; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding: 0.75rem 1rem; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); border-top: 1px solid var(--border); }
        .nav-items { display: flex; justify-content: space-around; align-items: center; max-width: 400px; margin: 0 auto; }
        .nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-secondary); padding: 0.5rem; border-radius: 0.75rem; min-width: 4rem; transition: all 0.2s; }
        .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.05); }
        .nav-item.active { color: var(--primary); background: rgba(236,72,153,0.1); }
        .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .nav-item span { font-size: 0.75rem; font-weight: 500; }

        /* === Enhanced Button Styles === */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; font-weight: 600; font-size: 0.875rem; cursor: pointer; border: none;
            transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
        }
        .btn-primary { background: var(--gradient); color: white; background-size: 200% auto; }
        .btn-primary:hover { background-position: right center; transform: translateY(-2px); box-shadow: 0 6px 12px -2px rgba(236,72,153,0.4); }
        .btn-secondary { background: var(--surface-light); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: #3f3f46; transform: translateY(-2px); }
        .btn-icon { width: 2.5rem; height: 2.5rem; padding: 0; border-radius: 50%; }
        .btn-sm { padding: 0.4rem 1rem; font-size: 0.75rem; border-radius: 0.5rem; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: black; }
        .btn-gradient { background: var(--gradient-login); background-size: 200% auto; animation: gradientFlow 3s ease infinite; color: white; }

        .card { background: var(--surface); border-radius: 1rem; border: 1px solid var(--border); overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 12px 20px -8px rgba(236,72,153,0.2); border-color: var(--primary); }
        
        /* Content area with top/bottom padding */
        .content { 
            padding-top: 60px; 
            padding-bottom: 70px; 
            height: 100%; 
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        .page {
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            height: 100%;
        }
        
        #admin-page .px-4,
        #accounts-page .px-4,
        #profile-page .px-4,
        #contact-page .px-4,
        #notifications-page .px-4 {
            padding-bottom: 20px;
            overflow-y: visible;
        }

        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .input { width: 100%; padding: 0.75rem 1rem; background: var(--surface-light); border: 1px solid var(--border); border-radius: 0.75rem; color: var(--text); font-size: 0.875rem; transition: border 0.2s; }
        .input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(236,72,153,0.2); }
        .textarea { min-height: 80px; resize: vertical; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal { background: var(--surface); border-radius: 1.5rem; border: 1px solid var(--border); width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.25rem; font-weight: 700; background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.25rem; cursor: pointer; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .modal-close:hover { background: var(--surface-light); color: white; }
        .modal-body { padding: 1.5rem; }
        .modal-footer { display: flex; gap: 1rem; padding: 1rem 1.5rem 1.5rem; border-top: 1px solid var(--border); }

        /* Tab bar */
        .tab-bar { display: flex; gap: 0.5rem; background: var(--surface-light); padding: 0.5rem; border-radius: 2rem; }
        .tab-item { flex: 1; text-align: center; padding: 0.5rem; border-radius: 2rem; font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .tab-item.active { background: var(--gradient); color: white; }

        /* Account cards */
        .accounts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .account-card { background: var(--surface); border-radius: 1.5rem; border: 1px solid var(--border); padding: 1.5rem; transition: 0.2s; }
        .account-card:hover { border-color: var(--primary); box-shadow: 0 8px 16px rgba(236,72,153,0.15); }
        .account-icon { width: 3rem; height: 3rem; border-radius: 1rem; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem; }
        .account-icon.small { background: linear-gradient(135deg, #3b82f6, #8b5cf6); }
        .account-icon.medium { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .account-icon.big { background: linear-gradient(135deg, #10b981, #3b82f6); }
        .badge { padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.7rem; font-weight: 600; }
        .badge-primary { background: var(--primary); color: white; }
        .badge-secondary { background: var(--secondary); color: white; }
        .badge-warning { background: var(--warning); color: black; }
        .account-actions { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .account-action-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem; border-radius: 2rem; font-size: 0.8rem; font-weight: 600; border: none; cursor: pointer; transition: 0.2s; }
        .account-action-btn.book { background: var(--surface-light); color: var(--text); border: 1px solid var(--border); }
        .account-action-btn.book:hover { background: var(--primary); color: white; }
        .account-action-btn.buy { background: var(--gradient); color: white; }
        .account-action-btn.share { background: var(--surface-light); color: var(--text); border: 1px solid var(--border); }

        /* Auth Page Enhanced Styles */
        .auth-container { max-width: 400px; margin: 0 auto; padding: 1rem; }
        .auth-card { background: var(--surface); border-radius: 2rem; padding: 2rem; border: 1px solid var(--border); box-shadow: 0 20px 40px rgba(236,72,153,0.15); }
        .auth-header { text-align: center; margin-bottom: 2rem; }
        .auth-logo { width: 80px; height: 80px; margin: 0 auto 1rem; background: var(--gradient-login); background-size: 200% auto; animation: gradientFlow 3s ease infinite; border-radius: 1.5rem; display: flex; align-items: center; justify-content: center; }
        .auth-logo span { color: white; font-size: 2rem; font-weight: bold; }
        .auth-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; background: var(--gradient-login); -webkit-background-clip: text; background-clip: text; color: transparent; background-size: 200% auto; animation: gradientFlow 3s ease infinite; }
        .auth-subtitle { color: var(--text-secondary); font-size: 0.9rem; }
        .auth-divider { display: flex; align-items: center; text-align: center; margin: 1.5rem 0; color: var(--text-secondary); }
        .auth-divider::before, .auth-divider::after { content: ''; flex: 1; border-bottom: 1px solid var(--border); }
        .auth-divider span { padding: 0 1rem; font-size: 0.8rem; }
        .auth-switch { margin-top: 1.5rem; text-align: center; color: var(--text-secondary); }
        .auth-switch a { color: var(--primary); text-decoration: none; font-weight: 600; margin-left: 0.5rem; }
        .auth-switch a:hover { text-decoration: underline; }

        /* File upload */
        .file-upload-area { border: 2px dashed var(--border); border-radius: 1rem; padding: 2rem; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-upload-area:hover { border-color: var(--primary); background: rgba(236,72,153,0.05); }
        .file-upload-area.has-file { border-color: var(--success); background: rgba(16,185,129,0.05); }

        /* Progress bar */
        .progress-bar { background: var(--surface-light); height: 0.5rem; border-radius: 1rem; overflow: hidden; }
        .progress-fill { background: var(--gradient); height: 100%; transition: width 0.3s; }

        /* Toast */
        #toast { position: fixed; bottom: 80px; left: 16px; right: 16px; z-index: 3000; display: flex; justify-content: center; pointer-events: none; }
        #toast > div { max-width: 400px; width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); padding: 1rem; }

        /* Offline indicator */
        .offline-indicator { 
            position: fixed; 
            top: 60px; 
            left: 16px; 
            right: 16px; 
            background: var(--danger); 
            color: white; 
            padding: 0.75rem; 
            border-radius: 0.75rem; 
            text-align: center; 
            font-size: 0.875rem; 
            z-index: 2000; 
            transform: translateY(-100px); 
            transition: transform 0.3s; 
            display: none;
        }
        .offline-indicator.show { 
            transform: translateY(0); 
            display: block;
        }

        /* Notification bell - for video uploads only */
        .notification-bell { 
            position: fixed; 
            bottom: 90px; 
            right: 16px; 
            width: 48px; 
            height: 48px; 
            background: var(--gradient); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 1.25rem; 
            cursor: pointer; 
            z-index: 1500; 
            box-shadow: 0 4px 12px rgba(236,72,153,0.4); 
        }
        .notification-badge { 
            position: absolute; 
            top: -4px; 
            right: -4px; 
            background: var(--danger); 
            color: white; 
            font-size: 0.7rem; 
            min-width: 20px; 
            height: 20px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0 4px; 
        }

        /* PWA install button - Firefox compatible */
        .pwa-install-btn { 
            position: fixed; 
            bottom: 90px; 
            left: 16px; 
            background: var(--gradient); 
            color: white; 
            border: none; 
            border-radius: 2rem; 
            padding: 0.75rem 1.25rem; 
            font-weight: 600; 
            z-index: 1500; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            box-shadow: 0 4px 12px rgba(236,72,153,0.4);
            transition: all 0.3s ease;
        }
        .pwa-install-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(236,72,153,0.6);
        }
        .pwa-install-btn.hidden {
            display: none !important;
        }

        /* Firefox-specific fixes */
        @-moz-document url-prefix() {
            .pwa-install-btn {
                background: var(--primary);
                border: 1px solid rgba(255,255,255,0.2);
            }
            .install-instructions {
                border: 2px solid var(--primary);
            }
        }

        /* Country code select */
        .phone-input-container {
            display: flex;
            gap: 8px;
        }
        .country-code-select {
            width: 100px;
            padding: 0.75rem;
            background: var(--surface-light);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            color: var(--text);
            font-size: 0.875rem;
        }
        .phone-number-input {
            flex: 1;
        }

        /* iOS specific styles */
        @supports (-webkit-touch-callout: none) {
            .pwa-install-btn {
                bottom: 100px;
            }
        }

        /* Manual install instructions */
        .install-instructions {
            position: fixed;
            bottom: 150px;
            left: 16px;
            right: 16px;
            background: var(--surface);
            border: 2px solid var(--primary);
            border-radius: 1rem;
            padding: 1rem;
            z-index: 1600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }
        .install-instructions.hidden {
            display: none;
        }
        .install-instructions h4 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        .install-instructions p {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .install-instructions ol {
            margin-left: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        .install-instructions li {
            margin-bottom: 0.25rem;
        }
        .close-instructions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* Profile booked accounts section */
        .booked-accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        .booked-account-item {
            background: var(--surface-light);
            border-radius: 0.75rem;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        .booked-account-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .booked-account-item i {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 0.25rem;
        }
        .booked-account-item .title {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .booked-account-item .tier {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator">
        <i class="fas fa-wifi-slash"></i> You are currently offline. Some features may be limited.
    </div>

    <!-- PWA Install Button - Will be shown when available -->
    <button id="pwa-install-btn" class="pwa-install-btn hidden">
        <i class="fas fa-download"></i> Install App
    </button>

    <!-- Manual Install Instructions -->
    <div id="install-instructions" class="install-instructions hidden">
        <button class="close-instructions" onclick="closeInstallInstructions()"><i class="fas fa-times"></i></button>
        <h4><i class="fas fa-mobile-alt"></i> Install GK Store</h4>
        <p>To install this app on your device:</p>
        <div id="ios-instructions" class="hidden">
            <p><strong>iPhone/iPad:</strong></p>
            <ol>
                <li>Tap the <i class="fas fa-share-alt"></i> Share button</li>
                <li>Scroll down and tap "Add to Home Screen"</li>
                <li>Tap "Add" in the top right corner</li>
            </ol>
        </div>
        <div id="android-instructions" class="hidden">
            <p><strong>Android:</strong></p>
            <ol>
                <li>Tap the menu <i class="fas fa-ellipsis-vertical"></i> (3 dots)</li>
                <li>Tap "Install app" or "Add to Home screen"</li>
                <li>Tap "Install" to confirm</li>
            </ol>
        </div>
        <div id="firefox-instructions" class="hidden">
            <p><strong>Firefox:</strong></p>
            <ol>
                <li>Tap the menu <i class="fas fa-bars"></i> (3 lines)</li>
                <li>Select "Install" or "Add to Home screen"</li>
                <li>Follow the prompts to install</li>
            </ol>
            <p class="text-xs text-zinc-400 mt-2">Note: Firefox may require additional permissions</p>
        </div>
    </div>

    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-content">
            <a href="#home" class="logo" onclick="showPage('home')">
                <div class="logo-icon">
                    <span style="font-size: 1rem; color: white;">GK</span>
                </div>
                <span class="gradient-text">GK Store</span>
            </a>
            
            <div class="nav-actions">
                <button class="btn btn-icon btn-secondary" onclick="toggleLanguage()">
                    <i class="fas fa-globe"></i>
                </button>
                <button class="btn btn-icon btn-secondary" onclick="showPage('admin')">
                    <i class="fas fa-user-shield"></i>
                </button>
                <button class="btn btn-icon btn-secondary" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div id="content-container" class="content">
        <!-- Auth Page -->
        <div id="auth-page" class="page">
            <div class="auth-container">
                <div class="auth-card">
                    <!-- Login -->
                    <div id="login-form-container">
                        <div class="auth-header">
                            <div class="auth-logo">
                                <span>GK</span>
                            </div>
                            <h2 class="auth-title">Welcome Back!</h2>
                            <p class="auth-subtitle">Sign in to access premium content</p>
                        </div>
                        
                        <form id="login-form" onsubmit="return false;">
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-envelope" style="color: var(--primary); margin-right: 0.5rem;"></i>Email
                                </label>
                                <input type="email" class="input" id="login-email" placeholder="Enter your email" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-lock" style="color: var(--primary); margin-right: 0.5rem;"></i>Password
                                </label>
                                <input type="password" class="input" id="login-password" placeholder="Enter your password" required>
                            </div>
                            <div class="flex items-center justify-between mb-6">
                                <label class="flex items-center">
                                    <input type="checkbox" id="remember-me" class="mr-2">
                                    <span class="text-sm">Remember me</span>
                                </label>
                                <a href="#" class="text-sm text-primary" onclick="showForgotPassword()">Forgot password?</a>
                            </div>
                            <button type="button" class="btn btn-gradient w-full mb-4" onclick="login()">
                                <i class="fas fa-sign-in-alt"></i> Sign In
                            </button>
                        </form>
                        
                        <div class="auth-divider"><span>OR</span></div>
                        
                        <div class="auth-switch">
                            <span>Don't have an account?</span>
                            <a href="#" onclick="showSignupForm()">Sign up</a>
                        </div>
                    </div>
                    
                    <!-- Signup -->
                    <div id="signup-form-container" class="hidden">
                        <div class="auth-header">
                            <div class="auth-logo">
                                <span>GK</span>
                            </div>
                            <h2 class="auth-title">Create Account</h2>
                            <p class="auth-subtitle">Join GK Store today</p>
                        </div>
                        
                        <form id="signup-form" onsubmit="return false;">
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-user" style="color: var(--primary); margin-right: 0.5rem;"></i>Full Name
                                </label>
                                <input type="text" class="input" id="signup-name" placeholder="Enter your full name" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-envelope" style="color: var(--primary); margin-right: 0.5rem;"></i>Email
                                </label>
                                <input type="email" class="input" id="signup-email" placeholder="Enter your email" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-lock" style="color: var(--primary); margin-right: 0.5rem;"></i>Password
                                </label>
                                <input type="password" class="input" id="signup-password" placeholder="Create a password" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-lock" style="color: var(--primary); margin-right: 0.5rem;"></i>Confirm Password
                                </label>
                                <input type="password" class="input" id="signup-confirm-password" placeholder="Confirm your password" required>
                            </div>
                            <button type="button" class="btn btn-gradient w-full" onclick="signup()">
                                <i class="fas fa-user-plus"></i> Create Account
                            </button>
                        </form>
                        
                        <div class="auth-switch">
                            <span>Already have an account?</span>
                            <a href="#" onclick="showLoginForm()">Sign in</a>
                        </div>
                    </div>
                    
                    <!-- Forgot Password -->
                    <div id="forgot-password-container" class="hidden">
                        <div class="auth-header">
                            <div class="auth-logo">
                                <i class="fas fa-lock text-white text-3xl"></i>
                            </div>
                            <h2 class="auth-title">Reset Password</h2>
                            <p class="auth-subtitle">We'll send you a reset link</p>
                        </div>
                        
                        <form id="forgot-password-form" onsubmit="return false;">
                            <div class="input-group">
                                <label class="input-label">
                                    <i class="fas fa-envelope" style="color: var(--primary); margin-right: 0.5rem;"></i>Email
                                </label>
                                <input type="email" class="input" id="reset-email" placeholder="Enter your email" required>
                            </div>
                            <button type="button" class="btn btn-gradient w-full" onclick="resetPassword()">
                                <i class="fas fa-paper-plane"></i> Send Reset Link
                            </button>
                        </form>
                        
                        <div class="auth-switch">
                            <a href="#" onclick="showLoginForm()"><i class="fas fa-arrow-left mr-2"></i>Back to login</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Page -->
        <div id="home-page" class="page hidden">
            <div class="reels-container" id="reels-container">
                <!-- Videos dynamically inserted -->
            </div>
        </div>

        <!-- Accounts Page -->
        <div id="accounts-page" class="page hidden">
            <div class="px-4">
                <h2 class="text-2xl font-bold mb-6">Premium Accounts</h2>
                
                <div class="tab-bar mb-6">
                    <div class="tab-item active" onclick="filterAccounts('all')">All</div>
                    <div class="tab-item" onclick="filterAccounts('small')">Small</div>
                    <div class="tab-item" onclick="filterAccounts('medium')">Medium</div>
                    <div class="tab-item" onclick="filterAccounts('big')">Big</div>
                </div>
                
                <div id="accounts-grid" class="accounts-grid"></div>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profile-page" class="page hidden">
            <div class="px-4">
                <div class="flex flex-col items-center mb-8">
                    <div class="w-24 h-24 rounded-full gradient-bg flex items-center justify-center text-2xl font-bold mb-4">
                        <span>GK</span>
                    </div>
                    <h2 class="text-2xl font-bold" id="profile-name">User Profile</h2>
                    <p class="text-zinc-400" id="profile-email">user@example.com</p>
                </div>
                
                <div class="grid gap-4">
                    <div class="card p-4">
                        <h3 class="font-semibold mb-4">Account Information</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between"><span class="text-zinc-400">Name</span><span id="user-name">Loading...</span></div>
                            <div class="flex justify-between"><span class="text-zinc-400">Email</span><span id="user-email">Loading...</span></div>
                            <div class="flex justify-between"><span class="text-zinc-400">Member Since</span><span id="member-since">Loading...</span></div>
                        </div>
                    </div>
                    
                    <div class="card p-4">
                        <h3 class="font-semibold mb-4">Statistics</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-4 bg-surface-light rounded-lg">
                                <div class="text-2xl font-bold gradient-text" id="videos-watched-count">0</div>
                                <div class="text-sm text-zinc-400">Videos Watched</div>
                            </div>
                            <div class="text-center p-4 bg-surface-light rounded-lg">
                                <div class="text-2xl font-bold gradient-text" id="accounts-booked-count">0</div>
                                <div class="text-sm text-zinc-400">Accounts Booked</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Booked Accounts Section -->
                    <div class="card p-4">
                        <h3 class="font-semibold mb-4">Your Booked Accounts</h3>
                        <div id="booked-accounts-list" class="booked-accounts-grid">
                            <div class="text-zinc-400 text-center py-4">No booked accounts yet</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary w-full" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Contact Page -->
        <div id="contact-page" class="page hidden">
            <div class="px-4">
                <h2 class="text-2xl font-bold mb-6">Contact Us</h2>
                <div class="grid gap-6">
                    <div class="card p-4">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 rounded-full gradient-bg flex items-center justify-center"><i class="fas fa-whatsapp text-white"></i></div>
                            <div><h3 class="font-semibold">WhatsApp Support</h3><p class="text-zinc-400">+93 793066322</p></div>
                        </div>
                        <button class="btn btn-primary w-full" onclick="openWhatsApp()"><i class="fab fa-whatsapp"></i> Chat Now</button>
                    </div>
                    
                    <div class="card p-4">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 rounded-full bg-amber-500 flex items-center justify-center"><i class="fas fa-wallet text-white"></i></div>
                            <div><h3 class="font-semibold">USDT Address (TRC20)</h3><p class="text-zinc-400 text-sm">Send payment to this address</p></div>
                        </div>
                        <div class="bg-surface-light p-3 rounded-lg mb-4">
                            <code id="usdt-address" class="text-sm break-all">TYpeauzqbVusejMAhJPnXuSb7wY6p69ZoY</code>
                        </div>
                        <button class="btn btn-secondary w-full" onclick="copyUSDTAddress()"><i class="far fa-copy"></i> Copy Address</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Page -->
        <div id="admin-page" class="page hidden">
            <div class="px-4">
                <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>
                
                <div class="grid gap-6">
                    <div class="card p-4">
                        <h3 class="font-semibold mb-4">Admin Login</h3>
                        <form id="admin-login-form" onsubmit="return false;">
                            <div class="input-group">
                                <label class="input-label">Admin Email</label>
                                <input type="email" id="admin-email" class="input" required>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Admin Password</label>
                                <input type="password" id="admin-password" class="input" required>
                            </div>
                            <button type="button" class="btn btn-primary w-full" onclick="adminLogin()">
                                <i class="fas fa-lock"></i> Login as Admin
                            </button>
                        </form>
                    </div>
                    
                    <div id="admin-dashboard" class="hidden">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="card p-3 text-center"><div class="text-2xl font-bold gradient-text" id="admin-video-count">0</div><div class="text-sm text-zinc-400">Total Videos</div></div>
                            <div class="card p-3 text-center"><div class="text-2xl font-bold gradient-text" id="admin-registered-users">0</div><div class="text-sm text-zinc-400">Registered Users</div></div>
                            <div class="card p-3 text-center"><div class="text-2xl font-bold gradient-text" id="admin-online-users">1</div><div class="text-sm text-zinc-400">Online Users</div></div>
                            <div class="card p-3 text-center"><div class="text-2xl font-bold gradient-text" id="admin-sold-count">0</div><div class="text-sm text-zinc-400">Sold Accounts</div></div>
                        </div>
                        
                        <div class="card p-4 mb-6">
                            <h3 class="font-semibold mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-1 gap-3">
                                <button class="btn btn-secondary" onclick="showUploadVideo()"><i class="fas fa-upload"></i> Upload Video</button>
                                <button class="btn btn-secondary" onclick="showManageVideos()"><i class="fas fa-video"></i> Manage Videos</button>
                                <button class="btn btn-secondary" onclick="showBookRequests()"><i class="fas fa-bookmark"></i> Book Requests</button>
                                <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout Admin</button>
                            </div>
                        </div>
                        
                        <div class="card p-4">
                            <h3 class="font-semibold mb-4">Recent Activity</h3>
                            <div id="admin-recent-activity" class="space-y-3">
                                <div class="text-zinc-400 text-center">No recent activity</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Page -->
        <div id="notifications-page" class="page hidden">
            <div class="px-4">
                <h2 class="text-2xl font-bold mb-6">New Videos</h2>
                <div id="notifications-list" class="space-y-3"></div>
                <div id="notifications-empty" class="hidden text-center py-12">
                    <i class="far fa-bell text-4xl text-zinc-600 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">No New Videos</h3>
                    <p class="text-zinc-400">Check back later for new content</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <div class="nav-items">
            <a href="#accounts" class="nav-item" onclick="showPage('accounts')">
                <i class="fas fa-shopping-bag"></i>
                <span>Accounts</span>
            </a>
            <a href="#home" class="nav-item active" onclick="showPage('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#profile" class="nav-item" onclick="showPage('profile')">
                <i class="far fa-user"></i>
                <span>Profile</span>
            </a>
            <a href="#contact" class="nav-item" onclick="showPage('contact')">
                <i class="fas fa-headset"></i>
                <span>Contact</span>
            </a>
        </div>
    </nav>

    <!-- Notification Bell -->
    <div class="notification-bell" onclick="showPage('notifications')">
        <i class="far fa-bell"></i>
        <div id="notification-count" class="notification-badge hidden">0</div>
    </div>

    <!-- Rotate Screen Indicator -->
    <div id="rotate-indicator" class="rotate-indicator hidden">
        <i class="fas fa-undo-alt"></i> Rotate device for fullscreen
    </div>

    <!-- Modals -->
    <div id="book-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Book Account</h3>
                <button class="modal-close" onclick="closeModal('book-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="card glass-effect p-4 mb-4">
                    <h4 id="book-account-name" class="font-semibold mb-1"></h4>
                    <p id="book-account-tier" class="badge badge-secondary text-xs"></p>
                    <p id="book-account-price" class="text-lg font-bold mt-2"></p>
                </div>
                <form id="book-form" onsubmit="return false;">
                    <div class="input-group">
                        <label class="input-label">Your Name</label>
                        <input type="text" class="input" id="book-name" required>
                    </div>
                    <div class="input-group">
                        <label class="input-label">WhatsApp Number</label>
                        <div class="phone-input-container">
                            <select id="book-country-code" class="country-code-select">
                                <option value="93">+93 (Afghanistan)</option>
                                <option value="91">+91 (India)</option>
                                <option value="92">+92 (Pakistan)</option>
                                <option value="1">+1 (USA)</option>
                                <option value="44">+44 (UK)</option>
                                <option value="971">+971 (UAE)</option>
                                <option value="966">+966 (Saudi Arabia)</option>
                                <option value="20">+20 (Egypt)</option>
                                <option value="90">+90 (Turkey)</option>
                                <option value="49">+49 (Germany)</option>
                                <option value="33">+33 (France)</option>
                                <option value="61">+61 (Australia)</option>
                            </select>
                            <input type="tel" class="input phone-number-input" id="book-whatsapp" required placeholder="Phone number">
                        </div>
                        <p class="text-xs text-zinc-500 mt-1">Select your country code and enter your number</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary flex-1" onclick="closeModal('book-modal')">Cancel</button>
                <button class="btn btn-primary flex-1" onclick="submitBookRequest()">Submit</button>
            </div>
        </div>
    </div>

    <div id="buy-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Buy with USDT</h3>
                <button class="modal-close" onclick="closeModal('buy-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="card glass-effect p-4 mb-4">
                    <h4 id="buy-account-name" class="font-semibold mb-1"></h4>
                    <p id="buy-account-tier" class="badge badge-secondary text-xs"></p>
                    <p id="buy-account-price" class="text-2xl font-bold mt-2"></p>
                </div>
                <div class="bg-surface-light p-4 rounded-lg mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm text-zinc-400">USDT Address (TRC20)</span>
                        <button class="btn btn-sm btn-secondary" onclick="copyAddress()">Copy</button>
                    </div>
                    <code id="payment-address" class="text-sm break-all">TYpeauzqbVusejMAhJPnXuSb7wY6p69ZoY</code>
                </div>
                <button class="btn btn-primary w-full" onclick="openPaymentChat()">
                    <i class="fab fa-whatsapp"></i> Confirm on WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Share App</h3>
                <button class="modal-close" onclick="closeModal('share-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <h4 class="font-semibold text-center mb-4">GK Store App</h4>
                <div class="grid grid-cols-4 gap-3 mb-6">
                    <button class="flex flex-col items-center p-3 bg-surface-light rounded-lg" onclick="shareAppViaWhatsApp()"><i class="fab fa-whatsapp text-green-500 text-2xl mb-2"></i><span class="text-xs">WhatsApp</span></button>
                    <button class="flex flex-col items-center p-3 bg-surface-light rounded-lg" onclick="shareAppViaTelegram()"><i class="fab fa-telegram text-blue-500 text-2xl mb-2"></i><span class="text-xs">Telegram</span></button>
                    <button class="flex flex-col items-center p-3 bg-surface-light rounded-lg" onclick="copyAppLink()"><i class="fas fa-link text-purple-500 text-2xl mb-2"></i><span class="text-xs">Copy</span></button>
                    <button class="flex flex-col items-center p-3 bg-surface-light rounded-lg" onclick="shareAppViaSystem()"><i class="fas fa-share-alt text-pink-500 text-2xl mb-2"></i><span class="text-xs">More</span></button>
                </div>
            </div>
        </div>
    </div>

    <div id="upload-video-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Upload Video</h3>
                <button class="modal-close" onclick="closeModal('upload-video-modal'); resetUploadForm()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label class="input-label">Video Title</label>
                    <input type="text" class="input" id="video-title-input" placeholder="Enter video title" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Description / Info</label>
                    <textarea class="input textarea" id="video-description-input" placeholder="Write video information, details, or any text you want to display" rows="4"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">Price ($)</label>
                    <input type="number" class="input" id="video-price" step="0.01" placeholder="0.00" required>
                </div>
                <div class="input-group">
                    <label class="input-label">Tier</label>
                    <select class="input" id="video-tier" required>
                        <option value="">Select Tier</option>
                        <option value="small">Small (up to 100MB)</option>
                        <option value="medium">Medium (up to 200MB)</option>
                        <option value="big">Big (up to 500MB)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Video File</label>
                    <div class="file-upload-area" id="file-upload-area" onclick="document.getElementById('video-file').click()">
                        <i class="fas fa-cloud-upload-alt text-3xl text-primary mb-2"></i>
                        <p id="file-upload-text">Click to select video file</p>
                        <p class="text-xs text-zinc-500 mt-1">MP4, WebM, OGG (max 500MB)</p>
                        <input type="file" id="video-file" accept="video/mp4,video/webm,video/ogg" class="hidden" onchange="handleFileSelect(event)">
                    </div>
                    <div id="file-info" class="hidden mt-2 p-2 bg-surface-light rounded-lg">
                        <p class="text-sm"><span class="font-semibold">Selected:</span> <span id="file-name"></span></p>
                        <p class="text-sm"><span class="font-semibold">Size:</span> <span id="file-size"></span></p>
                    </div>
                </div>
                
                <div id="upload-status" class="upload-status hidden">
                    <div class="flex justify-between text-sm mb-1">
                        <span id="upload-status-text">Uploading...</span>
                        <span id="upload-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="upload-progress" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="flex gap-2 mt-4">
                    <button class="btn btn-secondary flex-1" onclick="closeModal('upload-video-modal'); resetUploadForm()">Cancel</button>
                    <button class="btn btn-primary flex-1" id="upload-btn" onclick="uploadVideo()"><i class="fas fa-upload"></i> Upload Video</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manage-videos-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Manage Videos</h3>
                <button class="modal-close" onclick="closeModal('manage-videos-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="tab-bar mb-4">
                    <div class="tab-item active" onclick="adminFilterVideos('all')">All</div>
                    <div class="tab-item" onclick="adminFilterVideos('small')">Small</div>
                    <div class="tab-item" onclick="adminFilterVideos('medium')">Medium</div>
                    <div class="tab-item" onclick="adminFilterVideos('big')">Big</div>
                </div>
                <div id="admin-videos-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div id="book-requests-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Book Requests</h3>
                <button class="modal-close" onclick="closeModal('book-requests-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="admin-book-requests-list" class="space-y-3 max-h-96 overflow-y-auto"></div>
                <div id="admin-book-requests-empty" class="hidden text-center py-8">
                    <i class="fas fa-inbox text-4xl text-zinc-600 mb-4"></i>
                    <h3>No Requests</h3>
                </div>
            </div>
        </div>
    </div>

    <div id="language-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 300px;">
            <div class="modal-header">
                <h3 class="modal-title">Select Language</h3>
                <button class="modal-close" onclick="closeModal('language-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body p-0">
                <button class="w-full p-4 text-left hover:bg-surface-light" onclick="setLanguage('en')"> English <i id="lang-en-check" class="fas fa-check text-primary float-right"></i></button>
                <button class="w-full p-4 text-left hover:bg-surface-light" onclick="setLanguage('ps')">  <i id="lang-ps-check" class="fas fa-check text-primary float-right hidden"></i></button>
                <button class="w-full p-4 text-left hover:bg-surface-light" onclick="setLanguage('fa')">  <i id="lang-fa-check" class="fas fa-check text-primary float-right hidden"></i></button>
            </div>
        </div>
    </div>

    <div id="welcome-modal" class="modal-overlay">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-body text-center">
                <div class="w-20 h-20 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <span style="color: white; font-size: 2rem;">GK</span>
                </div>
                <h2 class="text-2xl font-bold mb-4">Welcome to GK Store!</h2>
                <p class="text-zinc-400 mb-6">Your exclusive gateway to premium video content</p>
                <button class="btn btn-primary w-full" onclick="closeWelcomeModal()">Get Started <i class="fas fa-arrow-right ml-2"></i></button>
            </div>
        </div>
    </div>

    <div id="sql-setup-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Database Setup</h3>
                <button class="modal-close" onclick="closeModal('sql-setup-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Run this SQL in Supabase SQL Editor:</p>
                <pre class="bg-black text-green-400 p-3 rounded-lg text-xs overflow-x-auto">
-- First, create the book_requests table if it doesn't exist
CREATE TABLE IF NOT EXISTS book_requests (
    id SERIAL PRIMARY KEY,
    video_id TEXT NOT NULL,
    user_name TEXT NOT NULL,
    whatsapp_number TEXT NOT NULL,
    user_id TEXT,
    status TEXT DEFAULT 'pending',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE book_requests ENABLE ROW LEVEL SECURITY;

-- Allow anyone to insert (for public booking)
CREATE POLICY "Allow public insert"
ON book_requests
FOR INSERT
TO public
WITH CHECK (true);

-- Allow authenticated users to view all requests
CREATE POLICY "Allow authenticated users to view"
ON book_requests
FOR SELECT
TO authenticated
USING (true);

-- Allow authenticated users to delete requests
CREATE POLICY "Allow authenticated users to delete"
ON book_requests
FOR DELETE
TO authenticated
USING (true);

-- Allow authenticated users to update requests (for cancel)
CREATE POLICY "Allow authenticated users to update"
ON book_requests
FOR UPDATE
TO authenticated
USING (true)
WITH CHECK (true);
                </pre>
                <button class="btn btn-primary w-full mt-4" onclick="closeModal('sql-setup-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Video Info Drawer (Facebook Style) -->
    <div id="video-info-drawer" class="video-info-drawer-overlay hidden">
        <div class="video-info-drawer">
            <div class="video-info-drawer-header">
                <h3>Video Information</h3>
                <button class="video-info-drawer-close" onclick="closeVideoDrawer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="video-info-drawer-content" id="video-drawer-content">
                <!-- Content will be dynamically populated -->
            </div>
        </div>
    </div>

    <!-- Play/Pause Indicator -->
    <div id="play-pause-indicator" class="play-pause-indicator">
        <i class="fas fa-play"></i>
    </div>

    <!-- Toast -->
    <div id="toast" class="hidden">
        <div class="bg-surface border border-border rounded-lg shadow-xl p-4">
            <div class="flex items-start gap-3">
                <i id="toast-icon" class="fas fa-check-circle text-success"></i>
                <div class="flex-1">
                    <h4 id="toast-title" class="font-semibold"></h4>
                    <p id="toast-message" class="text-sm text-zinc-400"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Create a comprehensive service worker with caching
                const swCode = `
                    const CACHE_NAME = 'gk-store-v2';
                    const urlsToCache = [
                        './',
                        './index.html',
                        './manifest.json',
                        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
                        'https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js',
                        'https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-72-72.png',
                        'https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-96-96.png',
                        'https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-144-144.png',
                        'https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-192-192.png',
                        'https://shamsahmadzai06-source.github.io/GKStore/android-launchericon-512-512.png'
                    ];

                    // Install event - cache core assets
                    self.addEventListener('install', event => {
                        console.log('Service Worker: Installing...');
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => {
                                    console.log('Service Worker: Caching files');
                                    return cache.addAll(urlsToCache);
                                })
                                .then(() => self.skipWaiting())
                        );
                    });

                    // Activate event - clean up old caches
                    self.addEventListener('activate', event => {
                        console.log('Service Worker: Activating...');
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            console.log('Service Worker: Clearing old cache:', cacheName);
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            }).then(() => self.clients.claim())
                        );
                    });

                    // Fetch event - serve from cache, fallback to network
                    self.addEventListener('fetch', event => {
                        // Skip cross-origin requests like Supabase API
                        if (event.request.url.includes('supabase.co') || 
                            event.request.url.includes('unpkg.com') && !event.request.url.includes('supabase.js')) {
                            return;
                        }
                        
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => {
                                    // Return cached response if found
                                    if (response) {
                                        return response;
                                    }
                                    
                                    // Clone the request because it's a stream that can only be used once
                                    const fetchRequest = event.request.clone();
                                    
                                    return fetch(fetchRequest).then(
                                        networkResponse => {
                                            // Check if we received a valid response
                                            if (!networkResponse || networkResponse.status !== 200 || networkResponse.type !== 'basic') {
                                                return networkResponse;
                                            }
                                            
                                            // Clone the response because it's a stream that can only be used once
                                            const responseToCache = networkResponse.clone();
                                            
                                            caches.open(CACHE_NAME)
                                                .then(cache => {
                                                    cache.put(event.request, responseToCache);
                                                });
                                            
                                            return networkResponse;
                                        }
                                    ).catch(error => {
                                        console.log('Service Worker: Fetch failed:', error);
                                        // You could return a fallback offline page here
                                    });
                                })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(function(err) {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                    
                // Also try to register from a proper URL for better compatibility
                // Create a simple inline service worker as fallback
                const swInlineCode = \`
                    self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
                    self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
                    self.addEventListener('fetch', e => e.respondWith(
                        caches.match(e.request) || fetch(e.request)
                    ));
                \`;
                
                const inlineBlob = new Blob([swInlineCode], { type: 'application/javascript' });
                const inlineSwUrl = URL.createObjectURL(inlineBlob);
                
                navigator.serviceWorker.register(inlineSwUrl).catch(err => {
                    console.log('Inline SW registration failed:', err);
                });
            });
        }
    </script>

    <script>
        // === YOUR COMPLETE ORIGINAL JAVASCRIPT CODE ===
        // Supabase config
        const SUPABASE_URL = 'https://ieinqlpnubtwwkldqhab.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllaW5xbHBudJ3d3drbGRxaGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1MzA3ODcsImV4cCI6MjA4NjEwNjc4N30.sJsoTu1bHBgconNOPfXZk33Ttuy1ZKC2oW2SonBnQ4o';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // App state
        const appState = {
            currentPage: 'auth', 
            currentVideoIndex: 0, 
            videos: [], 
            accounts: [], 
            notifications: [],
            bookRequests: [], 
            language: 'en', 
            theme: 'dark', 
            isLoggedIn: false, 
            currentUser: null,
            isAdminLoggedIn: false, 
            userStats: { registeredUsers: 0, onlineUsers: 0 },
            currentUpload: { file: null, progress: 0 }, 
            shareVideo: null,
            currentVideoPlayer: null, 
            isFullscreen: false, 
            currentAccount: null,
            isPlaying: true, 
            scrollTimeout: null, 
            deferredPrompt: null, 
            orientationTimeout: null,
            wasPlayingBeforeRotate: false, 
            likedVideos: new Set(), 
            sessionCheckInterval: null,
            unseenVideosCount: 0, 
            lastVideoCheck: null,
            installInstructionsShown: false,
            lastSignupAttempt: 0,
            userBookedAccounts: []
        };

        // Initialize app
        async function initApp() {
            console.log('Initializing app...');
            loadPreferences();
            setupEventListeners();
            setupOrientationHandling();
            setupPWAInstall();
            await checkDatabaseSetup();
            
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                appState.currentUser = session.user;
                appState.isLoggedIn = true;
                appState.isAdminLoggedIn = true;
                
                showPage('home');
                await loadInitialData();
                startVideoCheckInterval();
            } else {
                showPage('auth');
            }
            
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN' && session) {
                    appState.currentUser = session.user;
                    appState.isLoggedIn = true;
                    appState.isAdminLoggedIn = true;
                    showPage('home');
                    loadInitialData();
                    startVideoCheckInterval();
                } else if (event === 'SIGNED_OUT') {
                    appState.isLoggedIn = false; 
                    appState.currentUser = null; 
                    appState.isAdminLoggedIn = false;
                    appState.unseenVideosCount = 0;
                    appState.userBookedAccounts = [];
                    updateNotificationBadge();
                    showPage('auth');
                    if (appState.videoCheckInterval) {
                        clearInterval(appState.videoCheckInterval);
                    }
                }
            });
            
            setTimeout(checkAndShowInstallButton, 2000);
        }

        function checkAndShowInstallButton() {
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone || 
                                document.referrer.includes('android-app://') ||
                                window.matchMedia('(display-mode: fullscreen)').matches ||
                                window.matchMedia('(display-mode: minimal-ui)').matches;
            
            if (isStandalone) {
                return;
            }
            
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (!isMobile) return;
            
            setTimeout(() => {
                if (!appState.installInstructionsShown) {
                    showInstallInstructions();
                }
            }, 5000);
        }

        function showInstallInstructions() {
            const instructions = document.getElementById('install-instructions');
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
            
            if (isIOS) {
                document.getElementById('ios-instructions').classList.remove('hidden');
                document.getElementById('android-instructions').classList.add('hidden');
                document.getElementById('firefox-instructions').classList.add('hidden');
            } else if (isAndroid) {
                if (isFirefox) {
                    document.getElementById('ios-instructions').classList.add('hidden');
                    document.getElementById('android-instructions').classList.add('hidden');
                    document.getElementById('firefox-instructions').classList.remove('hidden');
                } else {
                    document.getElementById('ios-instructions').classList.add('hidden');
                    document.getElementById('android-instructions').classList.remove('hidden');
                    document.getElementById('firefox-instructions').classList.add('hidden');
                }
            } else {
                return;
            }
            
            instructions.classList.remove('hidden');
            appState.installInstructionsShown = true;
            
            setTimeout(() => {
                instructions.classList.add('hidden');
            }, 10000);
        }

        function closeInstallInstructions() {
            document.getElementById('install-instructions').classList.add('hidden');
        }

        function startVideoCheckInterval() {
            appState.videoCheckInterval = setInterval(checkForNewVideos, 60000);
        }

        async function checkForNewVideos() {
            if (!appState.isLoggedIn) return;
            
            const lastCheck = appState.lastVideoCheck || new Date(0);
            const newVideos = appState.videos.filter(v => new Date(v.created_at) > lastCheck);
            
            if (newVideos.length > 0) {
                appState.unseenVideosCount = newVideos.length;
                updateNotificationBadge();
                
                newVideos.forEach(video => {
                    appState.notifications.unshift({
                        id: `video_${video.id}_${Date.now()}`,
                        type: 'new_video',
                        title: 'New Video Uploaded',
                        message: video.title,
                        description: video.description || 'Check out this new video',
                        video_id: video.id,
                        created_at: new Date().toISOString()
                    });
                });
            }
            
            appState.lastVideoCheck = new Date();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');
            if (appState.unseenVideosCount > 0) {
                badge.textContent = appState.unseenVideosCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) return showToast('error', 'Login Failed', 'Please enter email and password');
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) {
                    if (error.message.includes('rate limit')) {
                        showToast('error', 'Rate Limit', 'Too many attempts. Please try again later.');
                    } else {
                        throw error;
                    }
                    return;
                }
                if (data.user) {
                    appState.currentUser = data.user;
                    appState.isLoggedIn = true;
                    appState.isAdminLoggedIn = true;
                    showToast('success', 'Welcome!', 'Login successful');
                    showPage('home');
                    await loadInitialData();
                }
            } catch (error) { showToast('error', 'Login Failed', error.message); }
        }

        async function signup() {
            const now = Date.now();
            if (now - appState.lastSignupAttempt < 10000) {
                showToast('error', 'Rate Limited', 'Please wait a few seconds before trying again');
                return;
            }
            
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm-password').value;
            
            if (!name || !email || !password) return showToast('error', 'Signup Failed', 'Please fill all fields');
            if (password !== confirm) return showToast('error', 'Signup Failed', 'Passwords do not match');
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) return showToast('error', 'Invalid Email', 'Please enter a valid email address');
            
            if (password.length < 6) return showToast('error', 'Weak Password', 'Password must be at least 6 characters');
            
            try {
                appState.lastSignupAttempt = now;
                
                const { data, error } = await supabase.auth.signUp({ 
                    email, 
                    password, 
                    options: { data: { full_name: name } } 
                });
                
                if (error) {
                    if (error.message.includes('rate limit')) {
                        showToast('error', 'Rate Limited', 'Please wait a moment before trying again');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                if (data.user) {
                    appState.currentUser = data.user;
                    appState.isLoggedIn = true;
                    appState.isAdminLoggedIn = true;
                    
                    showToast('success', 'Welcome!', 'Account created successfully');
                    showPage('home');
                    await loadInitialData();
                }
                
            } catch (error) { 
                console.error('Signup error:', error);
                showToast('error', 'Signup Failed', error.message); 
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            appState.isLoggedIn = false; 
            appState.currentUser = null; 
            appState.isAdminLoggedIn = false;
            appState.likedVideos.clear();
            appState.unseenVideosCount = 0;
            appState.userBookedAccounts = [];
            updateNotificationBadge();
            showPage('auth');
            showToast('success', 'Logged Out', 'See you again!');
        }

        async function resetPassword() {
            const email = document.getElementById('reset-email').value;
            if (!email) return showToast('error', 'Reset Failed', 'Please enter your email');
            try {
                await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
                showToast('success', 'Reset Email Sent', 'Check your inbox');
                showLoginForm();
            } catch (error) { showToast('error', 'Reset Failed', error.message); }
        }

        async function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                appState.isAdminLoggedIn = true;
                appState.isLoggedIn = true;
                appState.currentUser = data.user;
                document.getElementById('admin-dashboard').classList.remove('hidden');
                showToast('success', 'Admin Login', 'Welcome admin');
                showPage('admin');
                updateAdminStats();
            } catch (error) { showToast('error', 'Admin Login Failed', error.message); }
        }

        function updateAdminStats() {
            document.getElementById('admin-video-count').textContent = appState.videos.length;
            document.getElementById('admin-registered-users').textContent = appState.userStats.registeredUsers || 5;
            document.getElementById('admin-online-users').textContent = appState.userStats.onlineUsers || 1;
            document.getElementById('admin-sold-count').textContent = appState.accounts.filter(a => a.sold).length;
        }

        async function showManageVideos() {
            if (!appState.isAdminLoggedIn) { showToast('error', 'Access Denied', 'Login as admin first'); return; }
            await loadAdminVideos();
            showModal('manage-videos-modal');
        }

        async function loadAdminVideos(filter = 'all') {
            const list = document.getElementById('admin-videos-list');
            const filtered = filter === 'all' ? appState.videos : appState.videos.filter(v => v.tier === filter);
            if (!filtered.length) { list.innerHTML = '<div class="text-center py-8 text-zinc-400">No videos found</div>'; return; }
            list.innerHTML = '';
            filtered.forEach(v => {
                list.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-surface-light rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center gap-2"><span class="font-medium">${v.title}</span><span class="badge ${v.tier === 'big' ? 'badge-primary' : v.tier === 'medium' ? 'badge-secondary' : 'badge-warning'}">${v.tier}</span></div>
                            <p class="text-xs text-zinc-400">ID: ${v.id}  $${v.price}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-sm btn-danger" onclick="deleteVideo('${v.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function adminFilterVideos(tier) {
            document.querySelectorAll('#manage-videos-modal .tab-item').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadAdminVideos(tier);
        }

        async function deleteVideo(id) {
            if (!appState.isAdminLoggedIn || !confirm('Delete this video permanently?')) return;
            
            try {
                showToast('info', 'Deleting...', 'Removing video from database');
                
                // First, delete related book requests
                const { error: bookRequestsError } = await supabase
                    .from('book_requests')
                    .delete()
                    .eq('video_id', id);
                    
                if (bookRequestsError) {
                    console.error('Error deleting book requests:', bookRequestsError);
                }
                
                // Delete related notifications
                const { error: notificationsError } = await supabase
                    .from('notifications')
                    .delete()
                    .eq('video_id', id);
                    
                if (notificationsError) {
                    console.error('Error deleting notifications:', notificationsError);
                }
                
                // Find video to get URL for storage deletion
                const video = appState.videos.find(v => v.id === id);
                if (video && video.url) {
                    // Extract file path from URL
                    const urlParts = video.url.split('/');
                    const fileName = urlParts[urlParts.length - 1];
                    
                    // Determine which bucket the video is in based on tier
                    const bucketName = video.tier === 'small' ? 'videos-small' : 
                                      video.tier === 'medium' ? 'videos-medium' : 'videos-big';
                    
                    // Delete from storage
                    await supabase.storage.from(bucketName).remove([fileName]);
                }
                
                // Delete from videos table
                const { error } = await supabase
                    .from('videos')
                    .delete()
                    .eq('video_id', id);
                    
                if (error) {
                    throw error;
                }
                
                // Update local state
                appState.videos = appState.videos.filter(v => v.id !== id);
                appState.accounts = appState.accounts.filter(a => a.id !== id);
                
                showToast('success', 'Deleted', 'Video permanently removed');
                loadAdminVideos();
                renderReels();
                
                if (appState.currentPage === 'accounts') {
                    loadAccountsContent();
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('error', 'Delete Failed', error.message);
            }
        }

        async function showBookRequests() {
            if (!appState.isAdminLoggedIn) { showToast('error', 'Access Denied', 'Login as admin first'); return; }
            await loadAdminBookRequests();
            showModal('book-requests-modal');
        }

        async function loadAdminBookRequests() {
            const list = document.getElementById('admin-book-requests-list');
            const empty = document.getElementById('admin-book-requests-empty');
            
            if (appState.bookRequests && appState.bookRequests.length > 0) {
                list.classList.remove('hidden'); 
                empty.classList.add('hidden');
                list.innerHTML = appState.bookRequests.map(r => {
                    const video = appState.videos.find(v => v.id === r.video_id);
                    return `
                        <div class="card bg-surface-light p-3" id="request-${r.id}">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold">${r.user_name}</h4>
                                <span class="text-xs text-zinc-400">${new Date(r.created_at).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm mb-2">${r.whatsapp_number}</p>
                            ${video ? `<p class="text-xs text-primary mb-2">Account: ${video.title} (${video.tier})</p>` : ''}
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-sm btn-success flex-1" onclick="contactRequester('${r.whatsapp_number}')"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                                <button class="btn btn-sm btn-danger flex-1" onclick="deleteBookRequest('${r.id}')"><i class="fas fa-trash"></i> Delete</button>
                                <button class="btn btn-sm btn-secondary flex-1" onclick="cancelBookRequest('${r.id}')"><i class="fas fa-times"></i> Cancel</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                list.classList.add('hidden'); 
                empty.classList.remove('hidden');
            }
        }

        async function deleteBookRequest(id) {
            if (!appState.isAdminLoggedIn) {
                showToast('error', 'Access Denied', 'Login as admin first');
                return;
            }
            
            if (!confirm('Delete this book request permanently?')) return;
            
            try {
                showToast('info', 'Deleting...', 'Removing book request');
                
                // Use the authenticated user's session to delete
                const { error } = await supabase
                    .from('book_requests')
                    .delete()
                    .eq('id', id);
                    
                if (error) {
                    console.error('Supabase delete error:', error);
                    // If it's an RLS error, inform user and show setup modal
                    if (error.code === '42501' || error.message.includes('policy')) {
                        showToast('error', 'Permission Denied', 'Check RLS policies');
                        showModal('sql-setup-modal');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                // Also delete from local state
                appState.bookRequests = appState.bookRequests.filter(r => r.id !== id);
                appState.userBookedAccounts = appState.userBookedAccounts.filter(acc => acc.requestId !== id);
                
                // Remove from DOM
                const requestElement = document.getElementById(`request-${id}`);
                if (requestElement) {
                    requestElement.remove();
                }
                
                // Check if list is empty
                const list = document.getElementById('admin-book-requests-list');
                const empty = document.getElementById('admin-book-requests-empty');
                
                if (appState.bookRequests.length === 0) {
                    list.innerHTML = '';
                    list.classList.add('hidden');
                    empty.classList.remove('hidden');
                }
                
                showToast('success', 'Deleted', 'Book request deleted successfully');
                
                if (appState.currentPage === 'profile') {
                    updateProfileInfo();
                }
                
            } catch (error) {
                console.error('Delete error:', error);
                showToast('error', 'Delete Failed', error.message);
            }
        }

        async function cancelBookRequest(id) {
            if (!appState.isAdminLoggedIn) {
                showToast('error', 'Access Denied', 'Login as admin first');
                return;
            }
            
            if (!confirm('Cancel this book request?')) return;
            
            try {
                // Instead of updating, we'll delete it since status might not exist
                const { error } = await supabase
                    .from('book_requests')
                    .delete()
                    .eq('id', id);
                    
                if (error) {
                    console.error('Cancel error:', error);
                    if (error.code === '42501' || error.message.includes('policy')) {
                        showToast('error', 'Permission Denied', 'Check RLS policies');
                        showModal('sql-setup-modal');
                    } else {
                        throw error;
                    }
                    return;
                }
                
                // Remove from local state
                appState.bookRequests = appState.bookRequests.filter(r => r.id !== id);
                appState.userBookedAccounts = appState.userBookedAccounts.filter(acc => acc.requestId !== id);
                
                // Remove from DOM
                const requestElement = document.getElementById(`request-${id}`);
                if (requestElement) {
                    requestElement.remove();
                }
                
                // Check if list is empty
                const list = document.getElementById('admin-book-requests-list');
                const empty = document.getElementById('admin-book-requests-empty');
                
                if (appState.bookRequests.length === 0) {
                    list.innerHTML = '';
                    list.classList.add('hidden');
                    empty.classList.remove('hidden');
                }
                
                showToast('success', 'Cancelled', 'Book request has been cancelled');
                
            } catch (error) {
                console.error('Cancel error:', error);
                showToast('error', 'Cancel Failed', error.message);
            }
        }

        function contactRequester(whatsappNumber) {
            let number = whatsappNumber.replace(/\D/g, '');
            if (number.startsWith('0')) {
                number = '93' + number.substring(1);
            }
            window.open(`https://wa.me/${number}`, '_blank');
        }

        async function likeFromReel(index) {
            if (!appState.isLoggedIn) { showToast('info', 'Login Required', 'Please login to like videos'); showPage('auth'); return; }
            const video = appState.videos[index];
            if (!video) return;
            if (appState.likedVideos.has(video.id)) { showToast('info', 'Already Liked', 'You have already liked this video'); return; }
            try {
                video.likes = (video.likes || 0) + 1;
                appState.likedVideos.add(video.id);
                updateReelStats(index, 'likes', video.likes);
                const reel = document.querySelector(`.reel-item[data-index="${index}"]`);
                if (reel) {
                    const likeBtn = reel.querySelector('.reel-action-btn[onclick*="likeFromReel"]');
                    if (likeBtn) likeBtn.classList.add('liked');
                }
                showToast('success', 'Liked!', 'Thanks for your like');
            } catch (error) { showToast('error', 'Like Failed', error.message); }
        }

        function rotateToFullscreen() {
            const video = document.querySelector(`.reel-video[data-index="${appState.currentVideoIndex}"]`);
            if (!video) return;
            
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                video.classList.remove('fullscreen-mode');
                document.body.classList.remove('video-playing');
                return;
            }
            
            if (video.requestFullscreen) video.requestFullscreen();
            else if (video.webkitRequestFullscreen) video.webkitRequestFullscreen();
            else if (video.webkitEnterFullscreen) video.webkitEnterFullscreen();
            
            video.classList.add('fullscreen-mode');
            document.body.classList.add('video-playing');
            
            const indicator = document.getElementById('rotate-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 3000);
        }

        // New function to show video info drawer (Facebook style)
        function showVideoDrawer(index) {
            const video = appState.videos[index];
            if (!video) return;
            
            appState.currentAccount = video.account || video;
            
            const drawer = document.getElementById('video-info-drawer');
            const content = document.getElementById('video-drawer-content');
            
            // Create formatted description with paragraphs
            const description = video.description || 'No additional information available for this video.';
            const descriptionHtml = description.split('\n').map(para => `<p>${para}</p>`).join('');
            
            content.innerHTML = `
                <div class="video-info-section">
                    <div class="video-info-section-title">Title</div>
                    <div class="video-info-section-content">${video.title}</div>
                </div>
                
                <div class="video-info-section">
                    <div class="video-info-section-title">Description</div>
                    <div class="video-info-section-content">${descriptionHtml}</div>
                </div>
                
                <div class="video-info-section">
                    <div class="video-info-section-title">Price</div>
                    <div class="video-info-price-tag">$${video.price}</div>
                </div>
                
                <div class="video-info-section">
                    <div class="video-info-section-title">Tier</div>
                    <div class="video-info-tier-badge">
                        <i class="fas ${video.tier === 'small' ? 'fa-user' : video.tier === 'medium' ? 'fa-user-tie' : 'fa-crown'}"></i>
                        ${video.tier.charAt(0).toUpperCase() + video.tier.slice(1)}
                    </div>
                </div>
                
                <div class="video-info-section">
                    <div class="video-info-section-title">Stats</div>
                    <div class="flex gap-4">
                        <span><i class="fas fa-eye text-primary"></i> ${video.views || 0} views</span>
                        <span><i class="fas fa-heart text-danger"></i> ${video.likes || 0} likes</span>
                    </div>
                </div>
                
                <div class="video-info-actions">
                    <button class="video-info-action-btn book" onclick="bookFromDrawer()">
                        <i class="fas fa-bookmark"></i> Book Now
                    </button>
                    <button class="video-info-action-btn buy" onclick="buyFromDrawer()">
                        <i class="fas fa-shopping-bag"></i> Buy Now
                    </button>
                </div>
            `;
            
            drawer.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeVideoDrawer() {
            document.getElementById('video-info-drawer').classList.add('hidden');
            document.body.style.overflow = '';
        }
        
        function bookFromDrawer() {
            if (appState.currentAccount) {
                document.getElementById('book-account-name').textContent = appState.currentAccount.title;
                document.getElementById('book-account-tier').textContent = appState.currentAccount.tier;
                document.getElementById('book-account-price').textContent = `$${appState.currentAccount.price}`;
                showModal('book-modal');
                closeVideoDrawer();
            }
        }
        
        function buyFromDrawer() {
            if (appState.currentAccount) {
                document.getElementById('buy-account-name').textContent = appState.currentAccount.title;
                document.getElementById('buy-account-tier').textContent = appState.currentAccount.tier;
                document.getElementById('buy-account-price').textContent = `$${appState.currentAccount.price}`;
                showModal('buy-modal');
                closeVideoDrawer();
            }
        }

        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        
        function handleFullscreenChange() {
            const video = document.querySelector(`.reel-video[data-index="${appState.currentVideoIndex}"]`);
            if (!document.fullscreenElement && !document.webkitFullscreenElement) {
                if (video) video.classList.remove('fullscreen-mode');
                document.body.classList.remove('video-playing');
            }
        }

        async function loadInitialData() {
            await Promise.all([loadVideos(), loadAccounts(), loadBookRequests()]);
            updateAdminStats();
            renderReels();
            updateProfileInfo();
        }

        async function loadVideos() {
            try {
                const { data, error } = await supabase
                    .from('videos')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    console.error('Error loading videos:', error);
                    if (error.code === '42P01') {
                        initializeWithDemoData();
                    }
                    return;
                }
                
                if (data && data.length > 0) {
                    appState.videos = data.map(v => ({
                        id: v.video_id,
                        title: v.video_title,
                        description: v.description,
                        views: v.views || 0,
                        likes: v.likes || 0,
                        url: v.video_url,
                        tier: v.account_tier,
                        price: v.price,
                        viewTracked: false,
                        created_at: v.created_at,
                        account: {
                            id: v.video_id,
                            title: v.video_title,
                            tier: v.account_tier,
                            price: v.price,
                            url: v.video_url
                        }
                    }));
                } else {
                    console.log('No videos found in database');
                    appState.videos = [];
                    appState.accounts = [];
                }
            } catch (error) {
                console.error('Error in loadVideos:', error);
                appState.videos = [];
                appState.accounts = [];
            }
        }

        async function loadAccounts() {
            try {
                const { data, error } = await supabase
                    .from('videos')
                    .select('video_id, video_title, description, account_tier, price, sold, video_url');
                    
                if (error || !data) {
                    console.error('Error loading accounts:', error);
                    return;
                }
                
                appState.accounts = data.map(v => ({ 
                    id: v.video_id, 
                    title: v.video_title, 
                    description: v.description, 
                    tier: v.account_tier, 
                    price: v.price, 
                    sold: v.sold || false, 
                    url: v.video_url 
                }));
            } catch (error) {
                console.error('Error in loadAccounts:', error);
            }
        }

        async function loadBookRequests() {
            try {
                const { data, error } = await supabase
                    .from('book_requests')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) { 
                    console.log('Error loading book requests:', error);
                    appState.bookRequests = []; 
                    return; 
                }
                
                if (data) {
                    appState.bookRequests = data;
                    
                    if (appState.currentUser) {
                        appState.userBookedAccounts = appState.bookRequests
                            .filter(r => r.user_id === appState.currentUser.id || 
                                   (r.whatsapp_number && appState.currentUser.email && 
                                    r.whatsapp_number.includes(appState.currentUser.email.split('@')[0])))
                            .map(r => {
                                const video = appState.videos.find(v => v.id === r.video_id);
                                return {
                                    requestId: r.id,
                                    videoId: r.video_id,
                                    title: video ? video.title : 'Unknown Account',
                                    tier: video ? video.tier : 'unknown',
                                    price: video ? video.price : 0,
                                    created_at: r.created_at,
                                    whatsapp: r.whatsapp_number
                                };
                            });
                    }
                }
            } catch (error) {
                console.log('Error in loadBookRequests:', error);
                appState.bookRequests = [];
            }
        }

        function initializeWithDemoData() {
            appState.videos = [
                { id: 'demo_001', title: 'Welcome to GK Store', description: 'Premium accounts marketplace - This is your first video with detailed information about our services. We offer premium video content at affordable prices.', views: 150, likes: 45, url: 'https://assets.mixkit.co/videos/preview/mixkit-close-up-of-a-blue-tit-1257-large.mp4', tier: 'small', price: 199, viewTracked: false, created_at: new Date().toISOString(), account: { id: 'demo_001', title: 'Welcome to GK Store', tier: 'small', price: 199 } },
                { id: 'demo_002', title: 'Premium Content', description: 'Exclusive videos with high quality - Watch this amazing content and enjoy the best video experience on our platform. Book now to get access.', views: 89, likes: 23, url: 'https://assets.mixkit.co/videos/preview/mixkit-tree-with-yellow-flowers-1173-large.mp4', tier: 'medium', price: 299, viewTracked: false, created_at: new Date().toISOString(), account: { id: 'demo_002', title: 'Premium Content', tier: 'medium', price: 299 } }
            ];
            appState.accounts = appState.videos.map(v => ({ id: v.id, title: v.title, description: v.description, tier: v.tier, price: v.price, sold: false, url: v.url }));
            
            appState.bookRequests = [
                {
                    id: 1,
                    video_id: 'demo_001',
                    user_name: 'John Doe',
                    whatsapp_number: '+93793066322',
                    user_id: 'demo_user',
                    created_at: new Date().toISOString()
                },
                {
                    id: 2,
                    video_id: 'demo_002',
                    user_name: 'Jane Smith',
                    whatsapp_number: '+93793123456',
                    user_id: 'demo_user',
                    created_at: new Date().toISOString()
                }
            ];
            
            if (appState.currentUser) {
                appState.userBookedAccounts = appState.bookRequests
                    .filter(r => r.user_id === appState.currentUser.id || r.user_id === 'demo_user')
                    .map(r => {
                        const video = appState.videos.find(v => v.id === r.video_id);
                        return {
                            requestId: r.id,
                            videoId: r.video_id,
                            title: video ? video.title : 'Unknown Account',
                            tier: video ? video.tier : 'unknown',
                            price: video ? video.price : 0,
                            created_at: r.created_at,
                            whatsapp: r.whatsapp_number
                        };
                    });
            }
        }

        // Draggable progress bar (scrubber) functionality
        function setupDraggableProgressBar(videoEl, container) {
            // Create progress bar elements if not exist
            let progressContainer = container.querySelector('.video-progress-container');
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.className = 'video-progress-container';
                progressContainer.innerHTML = '<div class="video-progress-fill"></div><div class="video-progress-handle"></div>';
                container.appendChild(progressContainer);
            }
            const progressFill = progressContainer.querySelector('.video-progress-fill');
            const progressHandle = progressContainer.querySelector('.video-progress-handle');

            let isDragging = false;

            const updateProgress = () => {
                if (!isDragging && videoEl.duration) {
                    const percent = (videoEl.currentTime / videoEl.duration) * 100;
                    progressFill.style.width = percent + '%';
                    progressHandle.style.left = percent + '%';
                }
            };

            const setPositionFromEvent = (e) => {
                if (!videoEl.duration) return;
                const rect = progressContainer.getBoundingClientRect();
                let clientX;
                if (e.touches) {
                    clientX = e.touches[0].clientX;
                } else {
                    clientX = e.clientX;
                }
                // Clamp between left and right
                let x = Math.max(rect.left, Math.min(clientX, rect.right));
                let percent = (x - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                progressFill.style.width = percent * 100 + '%';
                progressHandle.style.left = percent * 100 + '%';
                // Update video time
                videoEl.currentTime = percent * videoEl.duration;
            };

            const startDrag = (e) => {
                e.preventDefault(); // Prevent default touch actions
                isDragging = true;
                progressContainer.classList.add('dragging');
                setPositionFromEvent(e);
            };

            const onDrag = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                setPositionFromEvent(e);
            };

            const stopDrag = (e) => {
                if (isDragging) {
                    isDragging = false;
                    progressContainer.classList.remove('dragging');
                }
            };

            // Mouse events
            progressContainer.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', stopDrag);

            // Touch events
            progressContainer.addEventListener('touchstart', startDrag, { passive: false });
            window.addEventListener('touchmove', onDrag, { passive: false });
            window.addEventListener('touchend', stopDrag);
            window.addEventListener('touchcancel', stopDrag);

            videoEl.addEventListener('timeupdate', updateProgress);
            videoEl.addEventListener('loadedmetadata', updateProgress);
        }

        function renderReels() {
            const container = document.getElementById('reels-container');
            if (!container) return;
            container.innerHTML = '';
            
            if (!appState.videos.length) {
                container.innerHTML = '<div class="reel-item"><div class="text-center"><i class="fas fa-video text-4xl text-zinc-600 mb-4"></i><p class="text-zinc-400">No videos available</p></div></div>';
                return;
            }
            
            appState.videos.forEach((video, index) => {
                const reelItem = document.createElement('div'); 
                reelItem.className = 'reel-item'; 
                reelItem.setAttribute('data-index', index);
                
                const likedClass = appState.likedVideos.has(video.id) ? 'liked' : '';
                
                reelItem.innerHTML = `
                    <div class="reel-video-container">
                        <video class="reel-video" data-index="${index}" src="${video.url}" loop playsinline preload="metadata"></video>
                        <div class="reel-top-gradient"></div>
                        
                        <!-- Three Dots Info Button (Facebook Style) - Now on LEFT side -->
                        <div class="video-info-btn" onclick="event.stopPropagation(); showVideoDrawer(${index})">
                            <i class="fas fa-ellipsis-h"></i>
                        </div>
                        
                        <div class="reel-info">
                            <div class="reel-title"><i class="fas fa-music"></i><span>${video.title}</span></div>
                            <div class="reel-description">${video.description || 'Premium video content'}</div>
                            <div class="reel-stats">
                                <span><i class="fas fa-eye"></i> ${video.views || 0}</span>
                                <span class="like-count"><i class="fas fa-heart"></i> ${video.likes || 0}</span>
                                <span><i class="fas fa-tag"></i> $${video.price}</span>
                            </div>
                        </div>
                        
                        <div class="reel-actions">
                            <!-- Rotate button now at the top with proper spacing -->
                            <div class="reel-action-btn rotate-btn" onclick="rotateToFullscreen()">
                                <div class="icon-circle"><i class="fas fa-undo-alt"></i></div>
                                <span>Rotate</span>
                            </div>
                            <div class="reel-action-btn" onclick="bookFromReel(${index})">
                                <div class="icon-circle"><i class="fas fa-bookmark"></i></div>
                                <span>Book</span>
                            </div>
                            <div class="reel-action-btn" onclick="buyFromReel(${index})">
                                <div class="icon-circle"><i class="fas fa-shopping-bag"></i></div>
                                <span>Buy</span>
                            </div>
                            <div class="reel-action-btn ${likedClass}" onclick="likeFromReel(${index})">
                                <div class="icon-circle"><i class="fas fa-heart"></i></div>
                                <span class="like-count">${video.likes || 0}</span>
                            </div>
                            <div class="reel-action-btn" onclick="shareAppFromReel()">
                                <div class="icon-circle"><i class="fas fa-share"></i></div>
                                <span>Share</span>
                            </div>
                        </div>
                        
                        <div class="reel-overlay"></div>
                    </div>
                `;
                
                container.appendChild(reelItem);
                
                const videoEl = reelItem.querySelector('.reel-video');
                const videoContainer = reelItem.querySelector('.reel-video-container');
                
                // Attach draggable progress bar
                setupDraggableProgressBar(videoEl, videoContainer);

                videoEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    videoEl.paused ? videoEl.play() : videoEl.pause();
                    showPlayPauseIndicator(videoEl.paused ? 'pause' : 'play');
                });
                
                videoEl.addEventListener('play', () => {
                    if (!video.viewTracked) { 
                        video.views = (video.views || 0) + 1; 
                        video.viewTracked = true; 
                        updateReelStats(index, 'views', video.views); 
                    }
                });
            });
            
            setTimeout(() => playVideoAtIndex(0), 500);
        }

        function updateReelStats(index, stat, value) {
            const reel = document.querySelector(`.reel-item[data-index="${index}"]`);
            if (!reel) return;
            
            if (stat === 'views') {
                const viewsEl = reel.querySelector('.fa-eye').parentElement;
                viewsEl.innerHTML = `<i class="fas fa-eye"></i> ${value}`;
            } else if (stat === 'likes') {
                const likesEl = reel.querySelector('.fa-heart').parentElement;
                likesEl.innerHTML = `<i class="fas fa-heart"></i> ${value}`;
                const likeCount = reel.querySelector('.like-count');
                if (likeCount) likeCount.textContent = value;
            }
        }

        function playVideoAtIndex(index) {
            const video = document.querySelector(`.reel-video[data-index="${index}"]`);
            if (video) { 
                video.play().catch(() => {}); 
                appState.currentVideoPlayer = video; 
            }
        }

        function pauseAllVideos() { 
            document.querySelectorAll('.reel-video').forEach(v => v.pause()); 
        }

        function handleReelScroll() {
            const container = document.getElementById('reels-container');
            const reels = document.querySelectorAll('.reel-item');
            const containerHeight = container.clientHeight;
            const scrollTop = container.scrollTop;
            let activeIndex = Math.round(scrollTop / containerHeight);
            activeIndex = Math.max(0, Math.min(activeIndex, reels.length - 1));
            
            if (activeIndex !== appState.currentVideoIndex) {
                pauseAllVideos();
                appState.currentVideoIndex = activeIndex;
                playVideoAtIndex(activeIndex);
                closeVideoDrawer(); // Close drawer when switching videos
            }
        }

        function bookFromReel(index) {
            const video = appState.videos[index];
            if (video) {
                appState.currentAccount = video.account || video;
                document.getElementById('book-account-name').textContent = video.title;
                document.getElementById('book-account-tier').textContent = video.tier;
                document.getElementById('book-account-price').textContent = `$${video.price}`;
                showModal('book-modal');
            }
        }

        function buyFromReel(index) {
            const video = appState.videos[index];
            if (video) {
                appState.currentAccount = video.account || video;
                document.getElementById('buy-account-name').textContent = video.title;
                document.getElementById('buy-account-tier').textContent = video.tier;
                document.getElementById('buy-account-price').textContent = `$${video.price}`;
                showModal('buy-modal');
            }
        }

        async function submitBookRequest() {
            if (!appState.currentAccount) {
                showToast('error', 'Error', 'No account selected');
                return;
            }

            const name = document.getElementById('book-name').value.trim();
            const countryCode = document.getElementById('book-country-code').value;
            const phoneNumber = document.getElementById('book-whatsapp').value.trim();
            
            if (!name) {
                showToast('error', 'Validation Error', 'Please enter your name');
                return;
            }
            
            if (!phoneNumber) {
                showToast('error', 'Validation Error', 'Please enter your WhatsApp number');
                return;
            }
            
            // Format phone number
            const fullNumber = countryCode + phoneNumber.replace(/^0+/, '');
            
            try {
                showToast('info', 'Submitting...', 'Please wait');
                
                // Prepare the request data
                const requestData = {
                    video_id: appState.currentAccount.id,
                    user_name: name,
                    whatsapp_number: fullNumber,
                    user_id: appState.currentUser ? appState.currentUser.id : null,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                // Insert the book request
                const { data, error } = await supabase
                    .from('book_requests')
                    .insert([requestData])
                    .select();
                    
                if (error) {
                    console.error('Supabase insert error:', error);
                    
                    // Check for specific error types
                    if (error.code === '42P01') {
                        showToast('error', 'Table Not Found', 'Please run the SQL setup first');
                        showModal('sql-setup-modal');
                    } else if (error.code === '42501' || error.message.includes('permission denied') || error.message.includes('policy')) {
                        showToast('error', 'Permission Denied', 'Please run the SQL setup to fix permissions');
                        showModal('sql-setup-modal');
                    } else if (error.code === '23505') {
                        showToast('error', 'Duplicate Request', 'You have already booked this account');
                    } else {
                        showToast('error', 'Submission Failed', error.message || 'Unknown error occurred');
                    }
                    return;
                }
                
                if (data && data[0]) {
                    const newRequest = data[0];
                    
                    // Add to local state
                    appState.bookRequests.unshift(newRequest);
                    
                    // Add to user's booked accounts if logged in
                    if (appState.currentUser) {
                        appState.userBookedAccounts.unshift({
                            requestId: newRequest.id,
                            videoId: newRequest.video_id,
                            title: appState.currentAccount.title,
                            tier: appState.currentAccount.tier,
                            price: appState.currentAccount.price,
                            created_at: newRequest.created_at,
                            whatsapp: fullNumber
                        });
                    }
                    
                    // Show success message
                    showToast('success', 'Request Submitted!', 'We will contact you on WhatsApp soon');
                    
                    // Close modal and reset form
                    closeModal('book-modal');
                    document.getElementById('book-name').value = '';
                    document.getElementById('book-whatsapp').value = '';
                    
                    // Refresh data
                    await loadBookRequests();
                    await loadAdminBookRequests();
                    updateProfileInfo();
                }
                
            } catch (error) { 
                console.error('Submission error:', error);
                showToast('error', 'Submission Failed', error.message || 'Network error occurred'); 
            }
        }

        function showPage(page) {
            if (['home', 'accounts', 'profile', 'contact', 'admin', 'notifications'].includes(page) && !appState.isLoggedIn) page = 'auth';
            if (page === 'auth' && appState.isLoggedIn) page = 'home';
            
            document.querySelectorAll('[id$="-page"]').forEach(p => p.classList.add('hidden'));
            document.getElementById(`${page}-page`).classList.remove('hidden');
            appState.currentPage = page;
            
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelector(`.nav-item[href="#${page}"]`)?.classList.add('active');
            
            if (page === 'home') { 
                setTimeout(() => { 
                    pauseAllVideos(); 
                    playVideoAtIndex(appState.currentVideoIndex); 
                }, 100); 
                closeVideoDrawer();
            }
            if (page === 'accounts') loadAccountsContent();
            if (page === 'profile') updateProfileInfo();
            if (page === 'admin') {
                loadAdminBookRequests();
                updateAdminStats();
            }
            if (page === 'notifications') {
                appState.unseenVideosCount = 0;
                updateNotificationBadge();
                loadNotificationsPage();
            }
        }

        function loadAccountsContent(filterTier = 'all') {
            const grid = document.getElementById('accounts-grid');
            if (!grid) return;
            
            const filtered = filterTier === 'all' ? appState.accounts : appState.accounts.filter(a => a.tier === filterTier);
            grid.innerHTML = '';
            
            if (!filtered.length) { 
                grid.innerHTML = '<div class="col-span-2 text-center py-12">No accounts available</div>'; 
                return; 
            }
            
            filtered.forEach(a => {
                grid.innerHTML += `
                    <div class="account-card">
                        <div class="account-icon ${a.tier}" onclick="playVideoFromAccount('${a.id}')">
                            <i class="fas ${a.tier === 'small' ? 'fa-user' : a.tier === 'medium' ? 'fa-user-tie' : 'fa-crown'}"></i>
                        </div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold">${a.title}</h3>
                            <span class="badge ${a.tier === 'big' ? 'badge-primary' : a.tier === 'medium' ? 'badge-secondary' : 'badge-warning'}">${a.tier}</span>
                        </div>
                        <p class="text-zinc-400 text-sm mb-4">${a.description || 'Premium account'}</p>
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-2xl font-bold gradient-text">$${a.price}</span>
                        </div>
                        <div class="account-actions">
                            <button class="account-action-btn book" onclick="bookFromAccount('${a.id}')"><i class="fas fa-bookmark"></i> Book</button>
                            <button class="account-action-btn buy" onclick="buyFromAccount('${a.id}')"><i class="fas fa-shopping-bag"></i> Buy</button>
                            <button class="account-action-btn share" onclick="shareAppFromReel()"><i class="fas fa-share"></i> Share</button>
                        </div>
                    </div>
                `;
            });
        }

        function filterAccounts(tier) {
            document.querySelectorAll('#accounts-page .tab-item').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadAccountsContent(tier);
        }

        function playVideoFromAccount(id) {
            const index = appState.videos.findIndex(v => v.id === id);
            if (index !== -1) {
                appState.currentVideoIndex = index;
                showPage('home');
                setTimeout(() => { 
                    document.getElementById('reels-container').scrollTo({ 
                        top: index * document.getElementById('reels-container').clientHeight, 
                        behavior: 'smooth' 
                    }); 
                }, 100);
            }
        }

        function bookFromAccount(id) {
            const account = appState.accounts.find(a => a.id === id);
            if (account) { 
                appState.currentAccount = account; 
                document.getElementById('book-account-name').textContent = account.title; 
                document.getElementById('book-account-tier').textContent = account.tier; 
                document.getElementById('book-account-price').textContent = `$${account.price}`; 
                showModal('book-modal'); 
            }
        }

        function buyFromAccount(id) {
            const account = appState.accounts.find(a => a.id === id);
            if (account) { 
                appState.currentAccount = account; 
                document.getElementById('buy-account-name').textContent = account.title; 
                document.getElementById('buy-account-tier').textContent = account.tier; 
                document.getElementById('buy-account-price').textContent = `$${account.price}`; 
                showModal('buy-modal'); 
            }
        }

        function updateProfileInfo() {
            if (appState.currentUser) {
                document.getElementById('user-name').textContent = appState.currentUser.user_metadata?.full_name || 'User';
                document.getElementById('user-email').textContent = appState.currentUser.email;
                document.getElementById('profile-name').textContent = appState.currentUser.user_metadata?.full_name || 'User Profile';
                document.getElementById('profile-email').textContent = appState.currentUser.email;
                
                const created = new Date(appState.currentUser.created_at);
                document.getElementById('member-since').textContent = created.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                
                const watchedVideos = appState.videos.filter(v => v.viewTracked).length;
                document.getElementById('videos-watched-count').textContent = watchedVideos;
                
                document.getElementById('accounts-booked-count').textContent = appState.userBookedAccounts.length;
                
                renderBookedAccounts();
            }
        }

        function renderBookedAccounts() {
            const list = document.getElementById('booked-accounts-list');
            if (!list) return;
            
            if (appState.userBookedAccounts && appState.userBookedAccounts.length > 0) {
                list.innerHTML = appState.userBookedAccounts.map(acc => `
                    <div class="booked-account-item" onclick="playVideoFromAccount('${acc.videoId}')" title="Click to watch video">
                        <i class="fas ${acc.tier === 'small' ? 'fa-user' : acc.tier === 'medium' ? 'fa-user-tie' : 'fa-crown'}"></i>
                        <div class="title">${acc.title}</div>
                        <div class="tier">${acc.tier}  $${acc.price}</div>
                        <div class="text-xs text-zinc-500 mt-1">${new Date(acc.created_at).toLocaleDateString()}</div>
                    </div>
                `).join('');
            } else {
                list.innerHTML = '<div class="text-zinc-400 text-center py-4 col-span-3">No booked accounts yet</div>';
            }
        }

        function loadNotificationsPage() {
            const list = document.getElementById('notifications-list');
            const empty = document.getElementById('notifications-empty');
            
            if (appState.notifications && appState.notifications.length > 0) {
                list.classList.remove('hidden');
                empty.classList.add('hidden');
                list.innerHTML = appState.notifications.map(n => `
                    <div class="card p-4" onclick="playVideoFromAccount('${n.video_id}')">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full gradient-bg flex items-center justify-center">
                                <i class="fas fa-video text-white"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-semibold">${n.title}</h4>
                                    <span class="text-xs text-zinc-400">${new Date(n.created_at).toLocaleDateString()}</span>
                                </div>
                                <p class="text-sm text-primary mb-1">${n.message}</p>
                                <p class="text-xs text-zinc-400">${n.description}</p>
                                <button class="btn btn-sm btn-primary mt-2" onclick="event.stopPropagation(); playVideoFromAccount('${n.video_id}')">
                                    <i class="fas fa-play"></i> Watch Now
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
            }
        }

        function showModal(id) { 
            document.getElementById(id).classList.remove('hidden'); 
            document.body.style.overflow = 'hidden'; 
        }
        
        function closeModal(id) { 
            document.getElementById(id).classList.add('hidden'); 
            document.body.style.overflow = ''; 
        }
        
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-icon').className = `fas ${type === 'success' ? 'fa-check-circle text-success' : type === 'error' ? 'fa-exclamation-circle text-danger' : 'fa-info-circle text-primary'}`;
            document.getElementById('toast-title').textContent = title;
            document.getElementById('toast-message').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function showLoginForm() { 
            document.getElementById('login-form-container').classList.remove('hidden'); 
            document.getElementById('signup-form-container').classList.add('hidden'); 
            document.getElementById('forgot-password-container').classList.add('hidden'); 
        }
        
        function showSignupForm() { 
            document.getElementById('login-form-container').classList.add('hidden'); 
            document.getElementById('signup-form-container').classList.remove('hidden'); 
            document.getElementById('forgot-password-container').classList.add('hidden'); 
        }
        
        function showForgotPassword() { 
            document.getElementById('login-form-container').classList.add('hidden'); 
            document.getElementById('signup-form-container').classList.add('hidden'); 
            document.getElementById('forgot-password-container').classList.remove('hidden'); 
        }
        
        function closeWelcomeModal() { 
            closeModal('welcome-modal'); 
            showPage('auth'); 
        }
        
        function copyUSDTAddress() { 
            navigator.clipboard.writeText(document.getElementById('usdt-address').textContent); 
            showToast('success', 'Copied!', 'Address copied to clipboard'); 
        }
        
        function copyAddress() { 
            navigator.clipboard.writeText(document.getElementById('payment-address').textContent); 
            showToast('success', 'Copied!', 'Address copied to clipboard'); 
        }
        
        function openWhatsApp() { 
            const number = '93793066322';
            window.open(`https://wa.me/${number}?text=Hello%20GK%20Store`, '_blank'); 
        }
        
        function openPaymentChat() { 
            if (!appState.currentAccount) return; 
            const number = '93793066322';
            window.open(`https://wa.me/${number}?text=${encodeURIComponent(`I want to buy: ${appState.currentAccount.title} for $${appState.currentAccount.price}`)}`, '_blank'); 
        }
        
        function toggleLanguage() { 
            showModal('language-modal'); 
        }
        
        function setLanguage(lang) { 
            appState.language = lang; 
            localStorage.setItem('appLanguage', lang); 
            document.querySelectorAll('[id^="lang-"]').forEach(c => c.classList.add('hidden')); 
            document.getElementById(`lang-${lang}-check`).classList.remove('hidden'); 
            document.body.dir = ['ar','fa','ur','ps'].includes(lang) ? 'rtl' : 'ltr'; 
            closeModal('language-modal'); 
        }
        
        function toggleTheme() { 
            appState.theme = appState.theme === 'dark' ? 'light' : 'dark'; 
            localStorage.setItem('appTheme', appState.theme); 
            document.documentElement.setAttribute('data-theme', appState.theme); 
        }
        
        function loadPreferences() { 
            appState.language = localStorage.getItem('appLanguage') || 'en'; 
            appState.theme = localStorage.getItem('appTheme') || 'dark'; 
            document.documentElement.setAttribute('data-theme', appState.theme); 
        }
        
        function setupPWAInstall() { 
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone ||
                                window.matchMedia('(display-mode: fullscreen)').matches ||
                                window.matchMedia('(display-mode: minimal-ui)').matches;
            
            if (isStandalone) { 
                document.getElementById('pwa-install-btn')?.classList.add('hidden'); 
                return; 
            }
            
            window.addEventListener('beforeinstallprompt', (e) => { 
                e.preventDefault(); 
                appState.deferredPrompt = e; 
                showInstallButton(); 
            });
            
            setTimeout(() => {
                if (!appState.deferredPrompt && !isStandalone) {
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    if (isMobile) {
                        const isFirefox = navigator.userAgent.toLowerCase().indexOf('firefox') > -1;
                        if (isFirefox) {
                            showInstallInstructions();
                        } else {
                            const btn = document.getElementById('pwa-install-btn');
                            if (btn) {
                                btn.classList.remove('hidden');
                                btn.onclick = () => {
                                    showInstallInstructions();
                                };
                            }
                        }
                    }
                }
            }, 3000);
        }
        
        function showInstallButton() { 
            const btn = document.getElementById('pwa-install-btn'); 
            if (btn) { 
                btn.classList.remove('hidden'); 
                btn.onclick = async () => { 
                    if (appState.deferredPrompt) { 
                        appState.deferredPrompt.prompt(); 
                        const { outcome } = await appState.deferredPrompt.userChoice; 
                        console.log(`User response to install: ${outcome}`); 
                        appState.deferredPrompt = null; 
                        btn.classList.add('hidden'); 
                    } else {
                        showInstallInstructions();
                    }
                }; 
            } 
        }
        
        function setupEventListeners() { 
            document.getElementById('reels-container')?.addEventListener('scroll', () => { 
                clearTimeout(appState.scrollTimeout); 
                appState.scrollTimeout = setTimeout(handleReelScroll, 100); 
            }); 
            
            window.addEventListener('online', () => { 
                document.getElementById('offline-indicator').classList.remove('show'); 
                showToast('success', 'Back Online', 'Connection restored'); 
            }); 
            
            window.addEventListener('offline', () => { 
                document.getElementById('offline-indicator').classList.add('show'); 
                showToast('error', 'Offline', 'Connection lost'); 
            }); 
            
            if (!navigator.onLine) {
                document.getElementById('offline-indicator').classList.add('show');
            }
            
            // Close video drawer when clicking outside
            document.getElementById('video-info-drawer')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('video-info-drawer-overlay')) {
                    closeVideoDrawer();
                }
            });
        }
        
        function setupOrientationHandling() { 
            window.addEventListener('orientationchange', () => { 
                clearTimeout(appState.orientationTimeout); 
                appState.orientationTimeout = setTimeout(() => { 
                    if (appState.currentPage === 'home' && window.innerWidth > window.innerHeight && !document.fullscreenElement && !document.webkitFullscreenElement) {
                        rotateToFullscreen(); 
                    }
                }, 100); 
            }); 
        }
        
        function showPlayPauseIndicator(action) { 
            const indicator = document.getElementById('play-pause-indicator'); 
            indicator.innerHTML = `<i class="fas fa-${action === 'play' ? 'play' : 'pause'}"></i>`; 
            indicator.classList.add('show'); 
            setTimeout(() => indicator.classList.remove('show'), 500); 
        }
        
        async function checkDatabaseSetup() { 
            try { 
                const { error } = await supabase.from('book_requests').select('count').limit(1); 
                if (error?.code === '42P01') {
                    console.log('Book requests table not found');
                    showModal('sql-setup-modal');
                }
            } catch { 
                // Ignore
            } 
        }
        
        function shareAppFromReel() { 
            showModal('share-modal'); 
        }
        
        function shareAppViaWhatsApp() { 
            window.open(`https://wa.me/?text=${encodeURIComponent('Check out GK Store: ' + window.location.href)}`, '_blank'); 
            closeModal('share-modal'); 
        }
        
        function shareAppViaTelegram() { 
            window.open(`https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=GK%20Store`, '_blank'); 
            closeModal('share-modal'); 
        }
        
        function copyAppLink() { 
            navigator.clipboard.writeText(window.location.href); 
            showToast('success', 'Copied!', 'App link copied to clipboard'); 
            closeModal('share-modal'); 
        }
        
        function shareAppViaSystem() { 
            if (navigator.share) { 
                navigator.share({ 
                    title: 'GK Store', 
                    text: 'Check out GK Store - Premium Video Marketplace', 
                    url: window.location.href 
                }).catch(console.error); 
            } else { 
                copyAppLink(); 
            } 
            closeModal('share-modal'); 
        }
        
        function showUploadVideo() { 
            if (!appState.isAdminLoggedIn) { 
                showToast('error', 'Access Denied', 'Login as admin first'); 
                return; 
            } 
            resetUploadForm(); 
            showModal('upload-video-modal'); 
        }
        
        function resetUploadForm() { 
            document.getElementById('video-title-input').value = ''; 
            document.getElementById('video-description-input').value = ''; 
            document.getElementById('video-price').value = ''; 
            document.getElementById('video-tier').value = ''; 
            document.getElementById('video-file').value = ''; 
            
            const fileInfo = document.getElementById('file-info');
            const uploadStatus = document.getElementById('upload-status');
            const fileUploadArea = document.getElementById('file-upload-area');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadPercentage = document.getElementById('upload-percentage');
            const uploadBtn = document.getElementById('upload-btn');
            
            fileInfo.classList.add('hidden');
            uploadStatus.classList.add('hidden');
            fileUploadArea.classList.remove('has-file');
            
            if (uploadProgress) uploadProgress.style.width = '0%';
            if (uploadPercentage) uploadPercentage.textContent = '0%';
            if (uploadBtn) {
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('opacity-50');
            }
            
            appState.currentUpload.file = null; 
        }
        
        function handleFileSelect(e) { 
            const file = e.target.files[0]; 
            if (!file) return; 
            
            appState.currentUpload.file = file; 
            document.getElementById('file-info').classList.remove('hidden'); 
            document.getElementById('file-name').textContent = file.name; 
            document.getElementById('file-size').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB'; 
            document.getElementById('file-upload-area').classList.add('has-file'); 
        }
        
        async function uploadVideo() {
            if (!appState.isAdminLoggedIn) {
                showToast('error', 'Access Denied', 'Login as admin first');
                return;
            }
            
            // Get form values
            const title = document.getElementById('video-title-input').value.trim();
            const description = document.getElementById('video-description-input').value.trim();
            const price = parseFloat(document.getElementById('video-price').value);
            const tier = document.getElementById('video-tier').value;
            const file = appState.currentUpload.file;
            
            // Validate inputs
            if (!title) {
                showToast('error', 'Validation Error', 'Please enter a video title');
                return;
            }
            
            if (!price || price <= 0) {
                showToast('error', 'Validation Error', 'Please enter a valid price');
                return;
            }
            
            if (!tier) {
                showToast('error', 'Validation Error', 'Please select a tier');
                return;
            }
            
            if (!file) {
                showToast('error', 'Validation Error', 'Please select a video file');
                return;
            }
            
            // Determine which bucket to use based on tier
            let bucketName;
            let maxSize;
            
            switch(tier) {
                case 'small':
                    bucketName = 'videos-small';
                    maxSize = 100; // MB
                    break;
                case 'medium':
                    bucketName = 'videos-medium';
                    maxSize = 200; // MB
                    break;
                case 'big':
                    bucketName = 'videos-big';
                    maxSize = 500; // MB
                    break;
                default:
                    showToast('error', 'Invalid Tier', 'Please select a valid tier');
                    return;
            }
            
            // Check file size
            if (file.size > maxSize * 1024 * 1024) {
                showToast('error', 'File Too Large', `Maximum size for ${tier} tier is ${maxSize}MB`);
                return;
            }
            
            // Show upload status
            const uploadStatus = document.getElementById('upload-status');
            const uploadProgress = document.getElementById('upload-progress');
            const uploadPercentage = document.getElementById('upload-percentage');
            const uploadStatusText = document.getElementById('upload-status-text');
            const uploadBtn = document.getElementById('upload-btn');
            
            uploadStatus.classList.remove('hidden');
            uploadBtn.disabled = true;
            uploadBtn.classList.add('opacity-50');
            
            try {
                // Generate unique video ID
                const videoId = `video_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Upload to Supabase Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${videoId}.${fileExt}`;
                const filePath = fileName; // Just the filename
                
                uploadStatusText.textContent = `Uploading to ${bucketName}...`;
                
                // Use the correct bucket name based on tier
                const { data: storageData, error: storageError } = await supabase.storage
                    .from(bucketName)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (storageError) {
                    console.error('Storage upload error:', storageError);
                    
                    // Check for bucket not found error
                    if (storageError.message && storageError.message.includes('bucket')) {
                        showToast('error', 'Bucket Error', `Bucket '${bucketName}' not found. Please run the SQL setup first.`);
                    } else {
                        throw new Error(`Upload failed: ${storageError.message || 'Storage error'}`);
                    }
                    return;
                }
                
                // Update progress
                uploadProgress.style.width = '100%';
                uploadPercentage.textContent = '100%';
                uploadStatusText.textContent = 'Getting video URL...';
                
                // Get public URL from the correct bucket
                const { data: { publicUrl } } = supabase.storage
                    .from(bucketName)
                    .getPublicUrl(filePath);
                
                // Insert video record in database
                uploadStatusText.textContent = 'Saving to database...';
                
                const { data: dbData, error: dbError } = await supabase
                    .from('videos')
                    .insert([{
                        video_id: videoId,
                        video_title: title,
                        description: description || 'Premium video content',
                        account_tier: tier,
                        price: price,
                        video_url: publicUrl,
                        bucket_name: bucketName,
                        views: 0,
                        likes: 0,
                        sold: false,
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (dbError) {
                    console.error('Database insert error:', dbError);
                    // If database insert fails, clean up the uploaded file
                    try {
                        await supabase.storage.from(bucketName).remove([filePath]);
                    } catch (cleanupError) {
                        console.error('Cleanup error:', cleanupError);
                    }
                    throw new Error(`Database error: ${dbError.message || 'Failed to save video info'}`);
                }
                
                // Success!
                uploadStatusText.textContent = 'Upload complete!';
                
                // Add to local state
                const newVideo = {
                    id: videoId,
                    title: title,
                    description: description || 'Premium video content',
                    views: 0,
                    likes: 0,
                    url: publicUrl,
                    tier: tier,
                    price: price,
                    viewTracked: false,
                    created_at: new Date().toISOString(),
                    account: {
                        id: videoId,
                        title: title,
                        tier: tier,
                        price: price,
                        url: publicUrl
                    }
                };
                
                appState.videos.unshift(newVideo);
                appState.accounts.unshift({
                    id: videoId,
                    title: title,
                    description: description || 'Premium video content',
                    tier: tier,
                    price: price,
                    sold: false,
                    url: publicUrl
                });
                
                // Create notification for users
                await createVideoUploadNotification(newVideo);
                
                showToast('success', 'Upload Complete', 'Video uploaded successfully');
                
                // Close modal and reset form
                setTimeout(() => {
                    closeModal('upload-video-modal');
                    resetUploadForm();
                    
                    // Refresh views
                    renderReels();
                    if (appState.currentPage === 'accounts') {
                        loadAccountsContent();
                    }
                    updateAdminStats();
                }, 1500);
                
            } catch (error) {
                console.error('Upload error details:', error);
                showToast('error', 'Upload Failed', error.message || 'Unknown error occurred');
                
                // Reset progress
                uploadProgress.style.width = '0%';
                uploadPercentage.textContent = '0%';
                uploadStatusText.textContent = 'Upload failed';
                
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.classList.remove('opacity-50');
            }
        }

        async function createVideoUploadNotification(video) {
            try {
                const { error } = await supabase
                    .from('notifications')
                    .insert([{
                        type: 'new_video',
                        message: video.title,
                        video_id: video.id,
                        read: false,
                        created_at: new Date().toISOString()
                    }]);
                    
                if (error) {
                    console.error('Error creating notification:', error);
                }
                
                appState.notifications.unshift({
                    id: `notif_${Date.now()}`,
                    type: 'new_video',
                    title: 'New Video Uploaded',
                    message: video.title,
                    description: video.description,
                    video_id: video.id,
                    created_at: new Date().toISOString()
                });
                
                appState.unseenVideosCount++;
                updateNotificationBadge();
                
            } catch (error) {
                console.error('Error in notification creation:', error);
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Expose functions to global scope
        window.showPage = showPage; 
        window.login = login; 
        window.signup = signup; 
        window.logout = logout; 
        window.resetPassword = resetPassword; 
        window.adminLogin = adminLogin; 
        window.showLoginForm = showLoginForm; 
        window.showSignupForm = showSignupForm; 
        window.showForgotPassword = showForgotPassword; 
        window.closeWelcomeModal = closeWelcomeModal; 
        window.copyUSDTAddress = copyUSDTAddress; 
        window.copyAddress = copyAddress; 
        window.openWhatsApp = openWhatsApp; 
        window.openPaymentChat = openPaymentChat; 
        window.toggleLanguage = toggleLanguage; 
        window.setLanguage = setLanguage; 
        window.toggleTheme = toggleTheme; 
        window.showModal = showModal; 
        window.closeModal = closeModal; 
        window.rotateToFullscreen = rotateToFullscreen; 
        window.likeFromReel = likeFromReel; 
        window.bookFromReel = bookFromReel; 
        window.buyFromReel = buyFromReel; 
        window.submitBookRequest = submitBookRequest; 
        window.filterAccounts = filterAccounts; 
        window.playVideoFromAccount = playVideoFromAccount; 
        window.bookFromAccount = bookFromAccount; 
        window.buyFromAccount = buyFromAccount; 
        window.showUploadVideo = showUploadVideo; 
        window.showManageVideos = showManageVideos; 
        window.showBookRequests = showBookRequests; 
        window.adminFilterVideos = adminFilterVideos; 
        window.deleteVideo = deleteVideo; 
        window.contactRequester = contactRequester; 
        window.resetUploadForm = resetUploadForm; 
        window.handleFileSelect = handleFileSelect; 
        window.uploadVideo = uploadVideo; 
        window.shareAppFromReel = shareAppFromReel; 
        window.shareAppViaWhatsApp = shareAppViaWhatsApp; 
        window.shareAppViaTelegram = shareAppViaTelegram; 
        window.copyAppLink = copyAppLink; 
        window.shareAppViaSystem = shareAppViaSystem; 
        window.closeInstallInstructions = closeInstallInstructions; 
        window.deleteBookRequest = deleteBookRequest; 
        window.cancelBookRequest = cancelBookRequest;
        window.showVideoDrawer = showVideoDrawer;
        window.closeVideoDrawer = closeVideoDrawer;
        window.bookFromDrawer = bookFromDrawer;
        window.buyFromDrawer = buyFromDrawer;
    </script>
</body>
</html>
